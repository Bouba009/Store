<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر الجزائري المحترف</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --main-color: #ff6600;
            --text-color: #333;
            --bg-color: #f4f6f8;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --border-radius: 8px;
        }

        /* Themes */
        body.theme-orange { --main-color: #ff6600; }
        body.theme-green { --main-color: #27ae60; }
        body.theme-blue { --main-color: #2980b9; }
        body.theme-purple { --main-color: #8e44ad; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        body { background-color: var(--bg-color); color: var(--text-color); padding-bottom: 60px;}
        a { text-decoration: none; color: inherit; }
        
        /* --- General UI --- */
        .btn { cursor: pointer; padding: 12px 20px; border-radius: var(--border-radius); border: none; font-weight: bold; transition: 0.3s; font-size: 1rem; }
        .btn-primary { background: var(--main-color); color: white; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: #34495e; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: var(--border-radius); margin-bottom: 15px; background: #fff; transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--main-color); box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }

        /* --- Circles Options (Sizes/Colors) --- */
        .options-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; margin-bottom: 15px; }
        .circle-option {
            min-width: 45px; height: 45px; padding: 0 10px; display: flex; align-items: center; justify-content: center;
            border: 2px solid #ddd; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 0.9rem;
            transition: 0.2s; background: white; user-select: none;
        }
        .circle-option:hover { border-color: var(--main-color); }
        .circle-option.selected { background-color: var(--main-color); color: white; border-color: var(--main-color); transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* --- Header & Layout --- */
        header { background: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo-area h2 { color: var(--main-color); font-weight: 800; cursor: pointer; }
        .nav-icons { display: flex; gap: 15px; font-size: 1.2rem; color: #555; }
        
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Product Grid --- */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; max-width: 1200px; margin: auto; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); } }
        
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: 0.3s; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .p-img { width: 100%; height: 200px; object-fit: cover; }
        .p-info { padding: 15px; }
        .p-title { font-size: 1rem; margin-bottom: 5px; color: #333; }
        .price-box { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .new-price { color: var(--main-color); font-weight: 800; font-size: 1.2rem; }
        .old-price { text-decoration: line-through; color: #aaa; font-size: 0.9rem; }

        /* --- Product Details (Shopify Style) --- */
        .shopify-layout { max-width: 1000px; margin: 30px auto; display: grid; grid-template-columns: 1fr; gap: 30px; padding: 0 20px; }
        @media(min-width: 768px) { .shopify-layout { grid-template-columns: 1fr 1fr; } }
        
        .product-gallery img { width: 100%; border-radius: 12px; box-shadow: var(--shadow); }
        
        .shopify-form { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid #eee; }
        .form-title { font-size: 1.5rem; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: #555; }
        .summary-box { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; margin-top: 20px; }

        /* --- Admin Dashboard --- */
        .admin-panel { padding: 20px; max-width: 1200px; margin: auto; }
        
        /* Stats Cards (2 rows, 2 columns) */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-bottom: 4px solid var(--main-color); }
        .stat-num { font-size: 2rem; font-weight: 800; color: var(--main-color); margin-top: 10px; }
        .stat-label { color: #777; font-weight: bold; }

        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: #fff; padding: 10px 25px; border: 1px solid #ddd; cursor: pointer; border-radius: 20px; white-space: nowrap; }
        .tab-btn.active { background: var(--main-color); color: white; border-color: var(--main-color); }
        
        .admin-content { display: none; }
        .admin-content.active { display: block; animation: fadeIn 0.3s; }
        
        /* Orders Table */
        .orders-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); }
        .orders-table th, .orders-table td { padding: 15px; text-align: right; border-bottom: 1px solid #eee; }
        .orders-table th { background: #f8f9fa; color: #555; font-weight: 700; }
        .order-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; background: #eee; }

        /* --- Toggle Switch --- */
        .toggle-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #eee;}
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--main-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Color Tags in Admin */
        .color-tags-area { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .color-tag { background: #eee; padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .color-tag i { cursor: pointer; color: red; }

    </style>
</head>
<body class="theme-orange">

    <!-- Header -->
    <header>
        <div class="logo-area">
            <!-- النقر المزدوج هنا للدخول للأدمن -->
            <h2 id="store-title" ondblclick="nav('admin')">اسم المتجر</h2> 
        </div>
        <div class="nav-icons">
            <i class="fas fa-home" onclick="nav('home')"></i>
            <!-- تم إخفاء أيقونة الأدمن لزيادة الخصوصية -->
        </div>
    </header>

    <!-- HOME VIEW -->
    <div id="view-home" class="page-section active">
        <!-- Slider -->
        <div style="position: relative; height: 250px; overflow: hidden;" id="main-slider"></div>

        <!-- Marquee -->
        <div style="background: var(--main-color); color: white; padding: 10px; overflow: hidden; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <div style="display: inline-block; animation: marquee 15s linear infinite; font-weight: bold;" id="marquee-txt">
                توصيل سريع لجميع الولايات 58 - الدفع عند الاستلام - تخفيضات هائلة
            </div>
            <style>@keyframes marquee { 0% { transform: translateX(-100vw); } 100% { transform: translateX(100vw); } }</style>
        </div>

        <!-- Products -->
        <h2 style="text-align: center; margin: 30px 0; font-weight: 800;">أحدث العروض الحصرية</h2>
        <div class="grid" id="products-list">
            <p style="text-align:center; width:200%;">جاري التحميل...</p>
        </div>
    </div>

    <!-- PRODUCT DETAIL VIEW (Shopify Style) -->
    <div id="view-product" class="page-section">
        <div style="max-width: 1000px; margin: 10px auto; padding: 0 20px;">
            <button onclick="nav('home')" style="background:none; border:none; color:#777; cursor:pointer; font-size: 1rem;">
                <i class="fas fa-arrow-right"></i> العودة للمتجر
            </button>
        </div>

        <div class="shopify-layout">
            <!-- Left: Image & Info -->
            <div class="product-gallery">
                <div id="p-detail-img-container"></div>
                <div style="margin-top: 20px;">
                    <h1 id="p-detail-name" style="font-size: 1.8rem; margin-bottom: 10px;"></h1>
                    <h2 id="p-detail-price" style="color: var(--main-color); font-weight: 800;"></h2>
                    <p id="p-detail-desc" style="color: #666; line-height: 1.6; margin-top: 15px;"></p>
                </div>
            </div>

            <!-- Right: Order Form -->
            <div class="shopify-form">
                <h3 class="form-title">إكمال الطلب</h3>
                <form id="order-form" onsubmit="submitOrder(event)">
                    
                    <!-- Hidden inputs -->
                    <input type="hidden" id="ord-pid">
                    <input type="hidden" id="ord-pname">
                    <input type="hidden" id="ord-price">
                    <input type="hidden" id="ord-size">
                    <input type="hidden" id="ord-color">

                    <!-- Options -->
                    <div id="dynamic-selectors"></div>

                    <!-- Customer Info -->
                    <div class="form-group">
                        <label>الاسم الكامل</label>
                        <input type="text" id="ord-name" required placeholder="مثال: محمد بن علي">
                    </div>
                    
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="tel" id="ord-phone" required placeholder="05/06/07...">
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex:1">
                            <label>الولاية</label>
                            <select id="ord-wilaya" required>
                                <option value="">اختر الولاية</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label>البلدية</label>
                            <input type="text" id="ord-commune" required placeholder="اكتب بلديتك">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>العنوان الكامل (الحي، الشارع، رقم المنزل)</label>
                        <input type="text" id="ord-address" required placeholder="مثال: حي السلام، شارع 1 نوفمبر، منزل 12">
                    </div>

                    <div class="summary-box">
                        <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                            <span>المنتج:</span> <strong id="sum-name">...</strong>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                            <span>الإجمالي:</span> <strong id="sum-price" style="color:var(--main-color)">0 دج</strong>
                        </div>
                        <small id="sum-opts" style="display:block; color:#777; margin-top:5px;"></small>
                    </div>

                    <button type="submit" class="btn btn-primary" style="margin-top: 20px; font-size: 1.1rem;">
                        <i class="fas fa-shopping-bag"></i> تأكيد الطلب (الدفع عند الاستلام)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN (Hidden) -->
    <div id="view-login" class="page-section">
        <div style="max-width:350px; margin: 80px auto; padding: 40px; background: white; text-align: center; border-radius: 12px; box-shadow: var(--shadow);">
            <h3 style="margin-bottom: 20px;">مدخل المسؤولين</h3>
            <input type="text" id="adm-user" placeholder="اسم المستخدم">
            <input type="password" id="adm-pass" placeholder="كلمة المرور">
            <button onclick="login()" class="btn btn-primary">تسجيل الدخول</button>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="view-admin" class="page-section">
        <div class="admin-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2><i class="fas fa-chart-line"></i> لوحة التحكم</h2>
                <button onclick="logout()" class="btn btn-danger" style="width:auto; padding: 8px 15px;">خروج</button>
            </div>

            <!-- Stats Grid (2x2) -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">إجمالي الطلبات</span>
                    <span class="stat-num" id="st-orders">0</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">عدد المنتجات</span>
                    <span class="stat-num" id="st-products">0</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">المداخيل المتوقعة</span>
                    <span class="stat-num" id="st-revenue">0 دج</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">زيارات الموقع</span>
                    <span class="stat-num">∞</span> <!-- يمكن ربطه بـ Analytics لاحقاً -->
                </div>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" onclick="tab('orders')">الطلبات الواردة</button>
                <button class="tab-btn" onclick="tab('products')">إدارة المنتجات</button>
                <button class="tab-btn" onclick="tab('list')">قائمة المنتجات</button>
                <button class="tab-btn" onclick="tab('settings')">الإعدادات</button>
            </div>

            <!-- Orders Tab -->
            <div id="tab-orders" class="admin-content active">
                <div style="overflow-x:auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>معلومات الزبون</th>
                                <th>الطلب</th>
                                <th>السعر</th>
                                <th>العنوان الكامل</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Product Tab -->
            <div id="tab-products" class="admin-content">
                <div style="background:white; padding:30px; border-radius:12px; box-shadow: var(--shadow);">
                    <h3 id="form-header-text">إضافة منتج جديد</h3>
                    <input type="hidden" id="edit-prod-id"> <!-- ID للتعديل -->
                    
                    <input type="text" id="new-name" placeholder="اسم المنتج">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="new-price" placeholder="السعر (دج)">
                        <input type="number" id="new-old-price" placeholder="السعر القديم (للعروض)">
                    </div>
                    <textarea id="new-desc" placeholder="وصف المنتج" rows="4"></textarea>
                    
                    <!-- Image Selection -->
                    <div style="margin-bottom:15px; border:1px solid #eee; padding:15px; border-radius:8px;">
                        <label>صورة المنتج:</label><br>
                        <div style="margin: 10px 0;">
                            <input type="radio" name="imgType" value="url" checked onclick="toggleImgInput('url')"> رابط مباشر
                            <input type="radio" name="imgType" value="file" onclick="toggleImgInput('file')"> رفع ملف
                        </div>
                        <input type="text" id="new-img-url" placeholder="https://..." style="margin-top:5px;">
                        <input type="file" id="new-img-file" style="display:none; margin-top:5px;" accept="image/*" onchange="convertBase64()">
                        <input type="hidden" id="final-img-data">
                        <img id="preview-img" style="max-height: 80px; margin-top: 10px; border-radius: 5px;">
                    </div>

                    <!-- Options Toggles -->
                    <div class="toggle-wrapper">
                        <label class="switch"><input type="checkbox" id="has-shoe-size"><span class="slider"></span></label>
                        <span>تفعيل مقاسات الأحذية (36 - 45)</span>
                    </div>

                    <div class="toggle-wrapper">
                        <label class="switch"><input type="checkbox" id="has-cloth-size" onchange="toggleClothType()"><span class="slider"></span></label>
                        <span>تفعيل مقاسات الملابس</span>
                        <select id="cloth-type-sel" style="width:auto; margin:0 10px; display:none;">
                            <option value="letters">أحرف (S, M, L...)</option>
                            <option value="numbers">أرقام (38, 40, 42...)</option>
                        </select>
                    </div>

                    <!-- Color Management (One by One) -->
                    <div class="toggle-wrapper" style="display:block;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span><label class="switch" style="vertical-align:middle; margin-left:10px;"><input type="checkbox" id="has-colors" onchange="toggleColorInput()"><span class="slider"></span></label> تفعيل الألوان</span>
                        </div>
                        <div id="color-input-area" style="display:none; margin-top: 10px; border-top:1px solid #eee; padding-top:10px;">
                            <div style="display:flex; gap:10px;">
                                <input type="text" id="single-color-input" placeholder="اكتب اللون (مثال: أحمر)" style="margin:0;">
                                <button onclick="addColorTag()" class="btn btn-secondary" style="width:auto;">إضافة</button>
                            </div>
                            <div class="color-tags-area" id="added-colors-container"></div>
                        </div>
                    </div>

                    <button onclick="saveProduct()" class="btn btn-primary" id="save-btn-txt">حفظ ونشر المنتج</button>
                    <button onclick="resetForm()" class="btn btn-danger" style="margin-top:10px; width:auto; display:none;" id="cancel-edit-btn">إلغاء التعديل</button>
                </div>
            </div>

            <!-- Product List Tab -->
            <div id="tab-list" class="admin-content">
                <div id="admin-p-list"></div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="admin-content">
                <div style="background:white; padding:20px; border-radius:12px;">
                    <label>اسم المتجر:</label> <input type="text" id="set-name">
                    <label>شريط العروض (Marquee):</label> <input type="text" id="set-marq">
                    <label>روابط صور السلايدر (رابط في كل سطر):</label> 
                    <textarea id="set-slider" rows="5"></textarea>
                    <label>لون المتجر (Theme):</label>
                    <select id="set-theme">
                        <option value="theme-orange">برتقالي (Orange)</option>
                        <option value="theme-green">أخضر (Green)</option>
                        <option value="theme-blue">أزرق (Blue)</option>
                        <option value="theme-purple">بنفسجي (Purple)</option>
                    </select>
                    <button onclick="saveSettings()" class="btn btn-primary">حفظ الإعدادات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o",
            authDomain: "mourafik-e9161.firebaseapp.com",
            projectId: "mourafik-e9161",
            storageBucket: "mourafik-e9161.firebasestorage.app",
            messagingSenderId: "133465287328",
            appId: "1:133465287328:web:9de5b3bd709099d885b7c5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ALGERIA DATA (58 WILAYAS) ---
        const wilayasList = [
            "01 أدرار", "02 الشلف", "03 الأغواط", "04 أم البواقي", "05 باتنة", "06 بجاية", "07 بسكرة", "08 بشار",
            "09 البليدة", "10 البويرة", "11 تمنراست", "12 تبسة", "13 تلمسان", "14 تيارت", "15 تيزي وزو", "16 الجزائر",
            "17 الجلفة", "18 جيجل", "19 سطيف", "20 سعيدة", "21 سكيكدة", "22 سيدي بلعباس", "23 عنابة", "24 قالمة",
            "25 قسنطينة", "26 المدية", "27 مستغانم", "28 المسيلة", "29 معسكر", "30 ورقلة", "31 وهران", "32 البيض",
            "33 إليزي", "34 برج بوعريريج", "35 بومرداس", "36 الطارف", "37 تندوف", "38 تيسمسيلت", "39 الوادي",
            "40 خنشلة", "41 سوق أهراس", "42 تيبازة", "43 ميلة", "44 عين الدفلى", "45 النعامة", "46 عين تموشنت",
            "47 غرداية", "48 غليزان", "49 تيميمون", "50 برج باجي مختار", "51 أولاد جلال", "52 بني عباس",
            "53 عين صالح", "54 عين قزام", "55 تقرت", "56 جانت", "57 المغير", "58 المنيعة"
        ];

        window.loadWilayas = () => {
            const sel = document.getElementById('ord-wilaya');
            sel.innerHTML = '<option value="">-- اختر الولاية --</option>';
            wilayasList.forEach(w => {
                sel.innerHTML += `<option value="${w}">${w}</option>`;
            });
        };

        // --- GLOBAL VARS ---
        let products = [];
        let currentProd = null;
        let tempColors = []; // For admin adding colors

        // --- NAVIGATION ---
        window.nav = (view) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            if(view === 'admin') {
                if(localStorage.getItem('adminAuth')) document.getElementById('view-admin').classList.add('active');
                else document.getElementById('view-login').classList.add('active');
            } else {
                document.getElementById('view-' + view).classList.add('active');
            }
            window.scrollTo(0,0);
        };

        window.tab = (t) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            event.target.classList.add('active');
        };

        // --- AUTH ---
        window.login = () => {
            const u = document.getElementById('adm-user').value;
            const p = document.getElementById('adm-pass').value;
            // يمكنك تغيير كلمة السر هنا
            if(u === 'admin' && p === 'admin123') {
                localStorage.setItem('adminAuth', 'true');
                nav('admin');
            } else alert('بيانات خاطئة');
        };
        window.logout = () => { localStorage.removeItem('adminAuth'); nav('home'); };

        // --- IMAGE HANDLER ---
        window.toggleImgInput = (type) => {
            document.getElementById('new-img-url').style.display = type === 'url' ? 'block' : 'none';
            document.getElementById('new-img-file').style.display = type === 'file' ? 'block' : 'none';
        };

        window.convertBase64 = () => {
            const file = document.getElementById('new-img-file').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('final-img-data').value = e.target.result;
                    document.getElementById('preview-img').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        // --- ADMIN: COLOR TAGS LOGIC ---
        window.toggleColorInput = () => {
            const check = document.getElementById('has-colors').checked;
            document.getElementById('color-input-area').style.display = check ? 'block' : 'none';
        };

        window.addColorTag = () => {
            const val = document.getElementById('single-color-input').value.trim();
            if(val && !tempColors.includes(val)) {
                tempColors.push(val);
                renderColorTags();
                document.getElementById('single-color-input').value = "";
            }
        };

        window.removeColorTag = (idx) => {
            tempColors.splice(idx, 1);
            renderColorTags();
        };

        function renderColorTags() {
            const c = document.getElementById('added-colors-container');
            c.innerHTML = "";
            tempColors.forEach((color, i) => {
                c.innerHTML += `<div class="color-tag">${color} <i class="fas fa-times-circle" onclick="removeColorTag(${i})"></i></div>`;
            });
        }

        // --- ADMIN: PRODUCT LOGIC (ADD & EDIT) ---
        window.toggleClothType = () => {
            const check = document.getElementById('has-cloth-size').checked;
            document.getElementById('cloth-type-sel').style.display = check ? 'inline-block' : 'none';
        };

        window.saveProduct = async () => {
            // Get Image
            let img = "";
            const imgType = document.querySelector('input[name="imgType"]:checked').value;
            if(imgType === 'url') img = document.getElementById('new-img-url').value;
            else img = document.getElementById('final-img-data').value;

            // Validate
            if(!document.getElementById('new-name').value || !document.getElementById('new-price').value) 
                return alert("الاسم والسعر مطلوبان");

            const prodData = {
                name: document.getElementById('new-name').value,
                price: document.getElementById('new-price').value,
                oldPrice: document.getElementById('new-old-price').value,
                desc: document.getElementById('new-desc').value,
                image: img,
                date: new Date().toISOString(),
                hasShoeSize: document.getElementById('has-shoe-size').checked,
                hasClothSize: document.getElementById('has-cloth-size').checked,
                clothType: document.getElementById('cloth-type-sel').value,
                hasColors: document.getElementById('has-colors').checked,
                colorsArray: tempColors // Save the array
            };

            const editId = document.getElementById('edit-prod-id').value;

            if(editId) {
                // UPDATE MODE
                if(!img) delete prodData.image; // Don't overwrite image if empty in update
                await updateDoc(doc(db, "products", editId), prodData);
                alert("تم التعديل بنجاح");
            } else {
                // CREATE MODE
                await addDoc(collection(db, "products"), prodData);
                alert("تم النشر بنجاح");
            }

            resetForm();
            nav('admin');
        };

        window.editP = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;

            // Fill Form
            document.getElementById('edit-prod-id').value = p.id;
            document.getElementById('new-name').value = p.name;
            document.getElementById('new-price').value = p.price;
            document.getElementById('new-old-price').value = p.oldPrice || "";
            document.getElementById('new-desc').value = p.desc || "";
            
            // Image Preview
            if(p.image) {
                document.getElementById('new-img-url').value = p.image;
                document.getElementById('preview-img').src = p.image;
            }

            // Options
            document.getElementById('has-shoe-size').checked = p.hasShoeSize || false;
            document.getElementById('has-cloth-size').checked = p.hasClothSize || false;
            document.getElementById('cloth-type-sel').value = p.clothType || "letters";
            toggleClothType();

            document.getElementById('has-colors').checked = p.hasColors || false;
            tempColors = p.colorsArray || [];
            toggleColorInput();
            renderColorTags();

            // UI Change
            document.getElementById('form-header-text').innerText = "تعديل المنتج: " + p.name;
            document.getElementById('save-btn-txt').innerText = "حفظ التعديلات";
            document.getElementById('cancel-edit-btn').style.display = "inline-block";
            
            tab('products');
        };

        window.resetForm = () => {
            document.getElementById('edit-prod-id').value = "";
            document.getElementById('new-name').value = "";
            document.getElementById('new-price').value = "";
            document.getElementById('new-old-price').value = "";
            document.getElementById('new-desc').value = "";
            document.getElementById('new-img-url').value = "";
            document.getElementById('final-img-data').value = "";
            document.getElementById('preview-img').src = "";
            
            document.getElementById('has-shoe-size').checked = false;
            document.getElementById('has-cloth-size').checked = false;
            document.getElementById('has-colors').checked = false;
            
            tempColors = [];
            renderColorTags();
            toggleClothType();
            toggleColorInput();

            document.getElementById('form-header-text').innerText = "إضافة منتج جديد";
            document.getElementById('save-btn-txt').innerText = "حفظ ونشر المنتج";
            document.getElementById('cancel-edit-btn').style.display = "none";
        };

        window.deleteP = async(id) => { if(confirm('حذف هذا المنتج نهائياً؟')) await deleteDoc(doc(db, "products", id)); };

        // --- APP LOGIC ---
        async function init() {
            loadWilayas();

            // Load Settings
            onSnapshot(doc(db, "settings", "main"), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    if(d.name) document.getElementById('store-title').innerText = d.name;
                    if(d.marquee) document.getElementById('marquee-txt').innerText = d.marquee;
                    if(d.theme) document.body.className = d.theme;
                    if(d.slider) {
                        const urls = d.slider.split('\n');
                        const sCont = document.getElementById('main-slider');
                        sCont.innerHTML = "";
                        urls.forEach((u, i) => {
                            if(u.trim()){
                                const div = document.createElement('div');
                                div.style = `position:absolute; width:100%; height:100%; background:url('${u.trim()}') center/cover; opacity:${i===0?1:0}; transition:1s;`;
                                div.className = 'slide-item';
                                sCont.appendChild(div);
                            }
                        });
                        startSlider();
                    }
                    // Fill admin inputs
                    document.getElementById('set-name').value = d.name || "";
                    document.getElementById('set-marq').value = d.marquee || "";
                    document.getElementById('set-slider').value = d.slider || "";
                    document.getElementById('set-theme').value = d.theme || "theme-orange";
                }
            });

            // Load Products
            onSnapshot(query(collection(db, "products"), orderBy("date", "desc")), (snap) => {
                products = [];
                const list = document.getElementById('products-list');
                const adminList = document.getElementById('admin-p-list');
                list.innerHTML = ""; adminList.innerHTML = "";
                
                document.getElementById('st-products').innerText = snap.size; // Stats

                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    products.push(p);
                    
                    // User Grid
                    const discount = p.oldPrice ? Math.round(((p.oldPrice - p.price)/p.oldPrice)*100) : 0;
                    list.innerHTML += `
                        <div class="product-card" onclick="openProduct('${p.id}')">
                            <img src="${p.image}" class="p-img">
                            ${discount ? `<span style="position:absolute; top:10px; right:10px; background:red; color:white; padding:2px 8px; border-radius:4px; font-weight:bold;">-${discount}%</span>` : ''}
                            <div class="p-info">
                                <h3 class="p-title">${p.name}</h3>
                                <div class="price-box">
                                    <span class="new-price">${p.price} دج</span>
                                    ${p.oldPrice ? `<span class="old-price">${p.oldPrice}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    // Admin List Item (with Edit)
                    adminList.innerHTML += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #eee; background:white;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <img src="${p.image}" width="50" height="50" style="object-fit:cover; border-radius:6px;">
                                <div>
                                    <b>${p.name}</b><br>
                                    <small>${p.price} دج</small>
                                </div>
                            </div>
                            <div>
                                <button onclick="editP('${p.id}')" class="btn-secondary" style="padding:5px 10px; font-size:0.8rem; margin-left:5px;">تعديل</button>
                                <button onclick="deleteP('${p.id}')" class="btn-danger" style="padding:5px 10px; font-size:0.8rem;">حذف</button>
                            </div>
                        </div>
                    `;
                });
            });

            // Load Orders (Admin)
            onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), (snap) => {
                const tb = document.getElementById('orders-tbody');
                tb.innerHTML = "";
                let totalRev = 0;
                document.getElementById('st-orders').innerText = snap.size;

                snap.forEach(d => {
                    const o = d.data();
                    totalRev += Number(o.price);
                    const dt = new Date(o.date).toLocaleDateString('ar-DZ');
                    
                    tb.innerHTML += `
                        <tr>
                            <td>${dt}</td>
                            <td>
                                <b>${o.custName}</b><br>
                                <a href="tel:${o.custPhone}" style="color:blue;">${o.custPhone}</a><br>
                                <span class="order-badge">${o.wilaya}</span>
                            </td>
                            <td>
                                <b>${o.pName}</b>
                                ${o.size ? `<br><small>المقاس: ${o.size}</small>` : ''}
                                ${o.color ? `<br><small>اللون: ${o.color}</small>` : ''}
                            </td>
                            <td style="color:green; font-weight:bold;">${o.price} دج</td>
                            <td><small>${o.address} - ${o.commune}</small></td>
                        </tr>
                    `;
                });
                document.getElementById('st-revenue').innerText = totalRev.toLocaleString() + " دج";
            });
        }

        // --- SLIDER ANIM ---
        function startSlider(){
            let idx = 0;
            setInterval(() => {
                const slides = document.querySelectorAll('.slide-item');
                if(slides.length > 0) {
                    slides.forEach(s => s.style.opacity = 0);
                    idx = (idx + 1) % slides.length;
                    slides[idx].style.opacity = 1;
                }
            }, 3000);
        }

        // --- PRODUCT DETAILS & SELECTION LOGIC ---
        window.openProduct = (id) => {
            currentProd = products.find(p => p.id === id);
            if(!currentProd) return;

            // Fill Data (Shopify Layout)
            document.getElementById('p-detail-img-container').innerHTML = `<img src="${currentProd.image}">`;
            document.getElementById('p-detail-name').innerText = currentProd.name;
            document.getElementById('p-detail-price').innerText = currentProd.price + " دج";
            document.getElementById('p-detail-desc').innerText = currentProd.desc || "لا يوجد وصف";

            document.getElementById('sum-name').innerText = currentProd.name;
            document.getElementById('sum-price').innerText = currentProd.price + " دج";

            // Generate Selectors
            const container = document.getElementById('dynamic-selectors');
            container.innerHTML = "";

            // 1. Sizes
            let sizes = [];
            if(currentProd.hasShoeSize) {
                sizes = [36,37,38,39,40,41,42,43,44,45];
            } else if (currentProd.hasClothSize) {
                if(currentProd.clothType === 'letters') sizes = ['S','M','L','XL','XXL','3XL'];
                else sizes = [38,40,42,44,46,48];
            }

            if(sizes.length > 0) {
                container.innerHTML += `<div class="form-group"><label>اختر المقاس:</label><div class="options-container" id="size-opts"></div></div>`;
                const sizeDiv = document.getElementById('size-opts');
                sizes.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'circle-option';
                    div.innerText = s;
                    div.onclick = function() {
                        document.querySelectorAll('#size-opts .circle-option').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('ord-size').value = s;
                        updateSummary();
                    };
                    sizeDiv.appendChild(div);
                });
            } else {
                document.getElementById('ord-size').value = "";
            }

            // 2. Colors (One by One)
            if(currentProd.hasColors && currentProd.colorsArray && currentProd.colorsArray.length > 0) {
                container.innerHTML += `<div class="form-group"><label>اختر اللون:</label><div class="options-container" id="col-opts"></div></div>`;
                const colDiv = document.getElementById('col-opts');
                currentProd.colorsArray.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'circle-option';
                    div.innerText = c;
                    div.onclick = function() {
                        document.querySelectorAll('#col-opts .circle-option').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('ord-color').value = c;
                        updateSummary();
                    };
                    colDiv.appendChild(div);
                });
            } else {
                document.getElementById('ord-color').value = "";
            }

            // Form Reset
            document.getElementById('ord-pid').value = currentProd.id;
            document.getElementById('ord-pname').value = currentProd.name;
            document.getElementById('ord-price').value = currentProd.price;
            document.getElementById('ord-size').value = "";
            document.getElementById('ord-color').value = "";
            document.getElementById('sum-opts').innerText = "";
            
            nav('product');
        };

        window.updateSummary = () => {
            const s = document.getElementById('ord-size').value;
            const c = document.getElementById('ord-color').value;
            let txt = "";
            if(s) txt += `المقاس: ${s} `;
            if(c) txt += `| اللون: ${c}`;
            document.getElementById('sum-opts').innerText = txt;
        };

        window.submitOrder = async (e) => {
            e.preventDefault();
            const p = currentProd;
            const s = document.getElementById('ord-size').value;
            const c = document.getElementById('ord-color').value;

            // Validation
            if((p.hasShoeSize || p.hasClothSize) && !s) return alert("يرجى اختيار المقاس");
            if(p.hasColors && !c && p.colorsArray && p.colorsArray.length > 0) return alert("يرجى اختيار اللون");

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الطلب...';

            const order = {
                pName: document.getElementById('ord-pname').value,
                price: document.getElementById('ord-price').value,
                custName: document.getElementById('ord-name').value,
                custPhone: document.getElementById('ord-phone').value,
                wilaya: document.getElementById('ord-wilaya').value,
                commune: document.getElementById('ord-commune').value,
                address: document.getElementById('ord-address').value,
                size: s,
                color: c,
                date: new Date().toISOString()
            };

            await addDoc(collection(db, "orders"), order);
            alert("تم استلام طلبك بنجاح! سنتصل بك قريباً للتأكيد.");
            nav('home');
            btn.disabled = false; btn.innerText = "تأكيد الطلب";
            e.target.reset();
        };

        window.saveSettings = async () => {
            const data = {
                name: document.getElementById('set-name').value,
                marquee: document.getElementById('set-marq').value,
                slider: document.getElementById('set-slider').value,
                theme: document.getElementById('set-theme').value
            };
            await setDoc(doc(db, "settings", "main"), data);
            alert("تم الحفظ");
            location.reload();
        };

        init();
    </script>
</body>
</html>
