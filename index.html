<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر الجزائري المحترف</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --main-color: #ff6600;
            --text-color: #333;
            --bg-color: #f4f6f8;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* Themes */
        body.theme-orange { --main-color: #ff6600; }
        body.theme-green { --main-color: #27ae60; }
        body.theme-blue { --main-color: #2980b9; }
        body.theme-purple { --main-color: #8e44ad; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        body { background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; min-height: 100vh;}
        a { text-decoration: none; color: inherit; cursor: pointer; }
        
        /* --- General UI --- */
        .btn { cursor: pointer; padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--main-color); color: white; width: 100%; }
        .btn-secondary { background: #555; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; background: #fff; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--main-color); box-shadow: 0 0 5px rgba(0,0,0,0.1); }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- Header --- */
        header { background: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo-area h2 { color: var(--main-color); font-weight: 800; font-size: 1.5rem; }
        .nav-icons { display: flex; gap: 20px; font-size: 1.3rem; color: #555; }
        .nav-icons i { cursor: pointer; transition: 0.2s; }
        .nav-icons i:hover { color: var(--main-color); }
        
        .page-section { display: none; animation: fadeIn 0.5s ease; padding-bottom: 40px; }
        .page-section.active { display: block; }

        /* --- Dashboard Stats (Admin) --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: space-between; border-right: 4px solid var(--main-color); }
        .stat-info h3 { font-size: 2rem; color: var(--text-color); margin-bottom: 5px; }
        .stat-info p { color: #777; font-size: 0.9rem; }
        .stat-icon { font-size: 2.5rem; color: var(--main-color); opacity: 0.2; }

        /* --- Product Grid --- */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; max-width: 1200px; margin: auto; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); } }
        
        .product-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: 0.3s; position: relative; }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .p-img { width: 100%; height: 200px; object-fit: cover; }
        .p-info { padding: 12px; }
        .price-box { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .new-price { color: var(--main-color); font-weight: 800; font-size: 1.2rem; }
        .old-price { text-decoration: line-through; color: #bbb; font-size: 0.9rem; }

        /* --- Product Details --- */
        .product-view-container { max-width: 900px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
        
        /* --- Circles Options (Sizes/Colors) --- */
        .options-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 20px; }
        .circle-option {
            min-width: 45px; height: 45px; padding: 0 10px; display: flex; align-items: center; justify-content: center;
            border: 2px solid #eee; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 0.9rem;
            transition: 0.2s; background: white; user-select: none;
        }
        .circle-option:hover { border-color: var(--main-color); }
        .circle-option.selected { border-color: var(--main-color); transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.15); }
        
        /* Special handling for colors to show actual color bg if possible */
        .color-circle { border-radius: 50%; width: 45px; height: 45px; border: 2px solid #eee; cursor: pointer; }
        .color-circle.selected { border: 3px solid var(--text-color); transform: scale(1.1); }

        /* --- Footer --- */
        footer { background: #2c3e50; color: white; padding: 40px 20px; margin-top: auto; }
        .footer-content { max-width: 1200px; margin: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; }
        .footer-col h3 { color: var(--main-color); margin-bottom: 15px; border-bottom: 2px solid var(--main-color); display: inline-block; padding-bottom: 5px; }
        .footer-col ul { list-style: none; }
        .footer-col li { margin-bottom: 10px; cursor: pointer; transition: 0.3s; }
        .footer-col li:hover { color: var(--main-color); padding-right: 5px; }
        .copyright { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #444; color: #888; font-size: 0.9rem; }

        /* --- Modals (Policies) --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .modal-box { background: white; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 25px; border-radius: 10px; position: relative; animation: popIn 0.3s; }
        .close-modal { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; cursor: pointer; color: #777; }
        .modal-content h2 { color: var(--main-color); margin-bottom: 15px; }
        .modal-content p { line-height: 1.6; color: #555; margin-bottom: 10px; }

        /* --- Admin Tabs --- */
        .admin-panel { padding: 20px; max-width: 1000px; margin: auto; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .tab-btn { background: #fff; padding: 10px 25px; border: 1px solid #ddd; cursor: pointer; border-radius: 30px; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--main-color); color: white; border-color: var(--main-color); }
        .admin-content { display: none; animation: fadeIn 0.4s; }
        .admin-content.active { display: block; }

        /* --- Toggle Switch --- */
        .toggle-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--main-color); }
        input:checked + .slider:before { transform: translateX(26px); }

    </style>
</head>
<body class="theme-orange">

    <!-- Header -->
    <header>
        <div class="logo-area">
            <h2 id="store-title">اسم المتجر</h2>
        </div>
        <div class="nav-icons">
            <i class="fas fa-home" onclick="nav('home')" title="الرئيسية"></i>
            <i class="fas fa-search" onclick="document.getElementById('search-input').focus()" title="بحث"></i>
            <i class="fas fa-user-shield" onclick="nav('admin')" title="الإدارة"></i>
        </div>
    </header>

    <!-- HOME VIEW -->
    <div id="view-home" class="page-section active">
        
        <!-- Slider -->
        <div style="position: relative; height: 300px; overflow: hidden; margin-bottom: 20px;" id="main-slider">
            <!-- Images Injected via JS -->
        </div>

        <!-- Marquee -->
        <div style="background: var(--main-color); color: white; padding: 10px; overflow: hidden; white-space: nowrap; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: inline-block; animation: marquee 20s linear infinite; font-weight: bold; font-size: 1.1rem;" id="marquee-txt">
                مرحباً بكم في متجرنا - أفضل العروض والتخفيضات تصلكم أينما كنتم في 58 ولاية
            </div>
            <style>@keyframes marquee { 0% { transform: translateX(-100%); } 100% { transform: translateX(100vw); } }</style>
        </div>

        <div style="max-width: 600px; margin: 20px auto; padding: 0 15px;">
            <input type="text" id="search-input" placeholder="ابحث عن منتج..." onkeyup="filterProducts()">
        </div>

        <!-- Products -->
        <h2 style="text-align: center; margin: 30px 0; position: relative; z-index: 1;">أحدث المنتجات</h2>
        <div class="grid" id="products-list">
            <p style="text-align:center; grid-column: span 2;">جاري التحميل...</p>
        </div>
    </div>

    <!-- PRODUCT DETAIL VIEW -->
    <div id="view-product" class="page-section">
        <div class="product-view-container">
            <button onclick="nav('home')" style="background:none; border:none; color:#777; margin-bottom:15px; cursor:pointer; font-size:1.1rem;">
                <i class="fas fa-arrow-right"></i> عودة للمتجر
            </button>
            <div id="p-detail-content"></div>

            <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">
            
            <form id="order-form" onsubmit="submitOrder(event)">
                <h3 style="color: var(--main-color); margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-truck"></i> استمارة الطلب
                </h3>
                
                <!-- Hidden inputs -->
                <input type="hidden" id="ord-pid">
                <input type="hidden" id="ord-pname">
                <input type="hidden" id="ord-price">
                <input type="hidden" id="ord-size" value="">
                <input type="hidden" id="ord-color" value="">

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div>
                        <label>الاسم واللقب:</label>
                        <input type="text" id="ord-name" required placeholder="الاسم الكامل">
                    </div>
                    <div>
                        <label>رقم الهاتف:</label>
                        <input type="tel" id="ord-phone" required placeholder="05/06/07...">
                    </div>
                </div>

                <label>الولاية:</label>
                <select id="ord-wilaya" required>
                    <option value="">-- اختر الولاية --</option>
                    <!-- Populated by JS -->
                </select>

                <label>البلدية / العنوان:</label>
                <input type="text" id="ord-address" required placeholder="اكتب اسم البلدية والحي...">

                <!-- Dynamic Options Selection -->
                <div id="dynamic-selectors"></div>

                <div style="margin-top: 25px; background: #e8f5e9; padding: 20px; border-radius: 8px; border: 1px solid #c8e6c9;">
                    <p style="font-weight: bold; font-size:1.1rem; margin-bottom:5px;">ملخص الطلب:</p>
                    <p id="order-summary" style="color:#2e7d32;">...</p>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 20px; font-size:1.2rem; padding:15px;">
                    <i class="fas fa-check-circle"></i> تأكيد الطلب الآن
                </button>
            </form>
        </div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="view-login" class="page-section">
        <div style="max-width:350px; margin: 80px auto; padding: 40px; background: white; text-align: center; box-shadow: var(--shadow); border-radius:10px;">
            <i class="fas fa-lock" style="font-size:3rem; color:var(--main-color); margin-bottom:20px;"></i>
            <h3>دخول المدير</h3>
            <input type="text" id="adm-user" placeholder="اسم المستخدم" style="margin-top:20px;">
            <input type="password" id="adm-pass" placeholder="كلمة المرور">
            <button onclick="login()" class="btn btn-primary">دخول</button>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="view-admin" class="page-section">
        <div class="admin-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h2><i class="fas fa-tachometer-alt"></i> لوحة التحكم</h2>
                <button onclick="logout()" class="btn btn-danger" style="width:auto;"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info">
                        <h3 id="st-orders">0</h3>
                        <p>إجمالي الطلبات</p>
                    </div>
                    <i class="fas fa-shopping-cart stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3 id="st-revenue">0</h3>
                        <p>المداخيل (دج)</p>
                    </div>
                    <i class="fas fa-wallet stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3 id="st-products">0</h3>
                        <p>عدد المنتجات</p>
                    </div>
                    <i class="fas fa-box-open stat-icon"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3 id="st-views">--</h3>
                        <p>الزوار (تقريبي)</p>
                    </div>
                    <i class="fas fa-users stat-icon"></i>
                </div>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" onclick="tab('orders')">الطلبات الواردة</button>
                <button class="tab-btn" onclick="tab('products')">إدارة المنتجات</button>
                <button class="tab-btn" onclick="tab('settings')">الإعدادات العامة</button>
            </div>

            <!-- Orders Tab -->
            <div id="tab-orders" class="admin-content active">
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; min-width:600px; background:white;" border="1" bordercolor="#eee">
                        <thead style="background:#f8f9fa;">
                            <tr>
                                <th style="padding:10px;">التاريخ</th>
                                <th style="padding:10px;">الزبون</th>
                                <th style="padding:10px;">التفاصيل</th>
                                <th style="padding:10px;">السعر</th>
                                <th style="padding:10px;">حذف</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody" style="text-align:center;"></tbody>
                    </table>
                </div>
            </div>

            <!-- Products Management Tab -->
            <div id="tab-products" class="admin-content">
                <div style="background:white; padding:25px; border-radius:10px; margin-bottom:20px; border:1px solid #eee;">
                    <h3 id="form-title" style="margin-bottom:15px; color:var(--main-color);">إضافة منتج جديد</h3>
                    <input type="hidden" id="edit-prod-id"> <!-- ID for editing -->

                    <input type="text" id="new-name" placeholder="اسم المنتج">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="new-price" placeholder="السعر (دج)">
                        <input type="number" id="new-old-price" placeholder="السعر القديم (اختياري)">
                    </div>
                    <textarea id="new-desc" placeholder="وصف المنتج وتفاصيله..." rows="4"></textarea>
                    
                    <!-- Image Selection -->
                    <div style="margin-bottom:15px; border:1px solid #eee; padding:15px; border-radius:5px;">
                        <label style="font-weight:bold;">صورة المنتج:</label><br>
                        <div style="margin:10px 0;">
                            <input type="radio" name="imgType" value="url" checked onclick="toggleImgInput('url')"> رابط
                            <input type="radio" name="imgType" value="file" onclick="toggleImgInput('file')"> رفع ملف
                        </div>
                        
                        <input type="text" id="new-img-url" placeholder="https://..." style="margin-top:5px;">
                        <input type="file" id="new-img-file" style="display:none; margin-top:5px;" accept="image/*" onchange="convertBase64()">
                        <input type="hidden" id="final-img-data">
                        <img id="preview-img" src="" style="width:60px; height:60px; object-fit:cover; display:none; margin-top:5px; border-radius:5px;">
                    </div>

                    <!-- Options Toggles -->
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                        <div class="toggle-wrapper">
                            <label class="switch"><input type="checkbox" id="has-shoe-size"><span class="slider"></span></label>
                            <span>مقاسات أحذية (36-45)</span>
                        </div>

                        <div class="toggle-wrapper">
                            <label class="switch"><input type="checkbox" id="has-cloth-size" onchange="toggleClothType()"><span class="slider"></span></label>
                            <span>مقاسات ملابس</span>
                            <select id="cloth-type-sel" style="width:auto; margin:0 10px; display:none; padding:5px;">
                                <option value="letters">أحرف (S, M...)</option>
                                <option value="numbers">أرقام (38, 40...)</option>
                            </select>
                        </div>

                        <div class="toggle-wrapper">
                            <label class="switch"><input type="checkbox" id="has-colors"><span class="slider"></span></label>
                            <span>تفعيل الألوان</span>
                        </div>
                    </div>
                    
                    <input type="text" id="color-list" placeholder="اكتب الألوان مفصولة بفاصلة (مثال: أحمر, أزرق, #000000)" style="display:none; margin-top:10px;">
                    <p style="font-size:0.8rem; color:#888; display:none;" id="color-hint">تلميح: يمكنك كتابة اسم اللون بالعربية أو الانجليزية أو كود Hex.</p>

                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button onclick="saveProduct()" id="save-btn" class="btn btn-primary">حفظ ونشر</button>
                        <button onclick="resetForm()" id="cancel-btn" class="btn btn-secondary" style="display:none;">إلغاء التعديل</button>
                    </div>
                </div>

                <div id="admin-p-list">
                    <!-- Products listed here for edit/delete -->
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="admin-content">
                <div style="background:white; padding:20px; border-radius:10px;">
                    <label>اسم المتجر:</label> <input type="text" id="set-name">
                    <label>النص المتحرك (Marquee):</label> <input type="text" id="set-marq">
                    <label>روابط صور السلايدر (كل رابط في سطر):</label> 
                    <textarea id="set-slider" rows="5" placeholder="https://img1.jpg&#10;https://img2.jpg"></textarea>
                    <label>لون المتجر (Theme):</label>
                    <select id="set-theme">
                        <option value="theme-orange">برتقالي (افتراضي)</option>
                        <option value="theme-green">أخضر</option>
                        <option value="theme-blue">أزرق</option>
                        <option value="theme-purple">بنفسجي</option>
                    </select>
                    <button onclick="saveSettings()" class="btn btn-primary">حفظ الإعدادات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="footer-content">
            <div class="footer-col">
                <h3>عن المتجر</h3>
                <p style="line-height:1.6; color:#ccc;">متجرنا الجزائري يقدم لكم أفضل المنتجات بجودة عالية وأسعار تنافسية مع خدمة توصيل لجميع الولايات.</p>
            </div>
            <div class="footer-col">
                <h3>روابط سريعة</h3>
                <ul>
                    <li onclick="nav('home')">الرئيسية</li>
                    <li onclick="showModal('shipping')">سياسة الشحن</li>
                    <li onclick="showModal('privacy')">سياسة الخصوصية</li>
                </ul>
            </div>
            <div class="footer-col">
                <h3>تواصل معنا</h3>
                <ul>
                    <li onclick="showModal('contact')">اتصل بنا</li>
                    <li onclick="showModal('about')">من نحن</li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            &copy; 2024 جميع الحقوق محفوظة للمتجر الجزائري المحترف.
        </div>
    </footer>

    <!-- MODALS -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modal-body" class="modal-content"></div>
        </div>
    </div>

    <!-- Hidden Content for Modals -->
    <div style="display:none;">
        <div id="content-shipping">
            <h2>سياسة الشحن والتوصيل</h2>
            <p>نحن نوفر خدمة التوصيل إلى 58 ولاية جزائرية.</p>
            <p><strong>مدة التوصيل:</strong> من 2 إلى 5 أيام عمل حسب الولاية.</p>
            <p><strong>أسعار التوصيل:</strong> تختلف حسب الولاية والبلدية، سيتم تأكيد السعر عند الاتصال بكم.</p>
            <p>الدفع يكون عند الاستلام (Main à main) بعد التأكد من المنتج.</p>
        </div>
        <div id="content-privacy">
            <h2>سياسة الخصوصية</h2>
            <p>نحن نحترم خصوصيتكم. المعلومات التي تقدمونها (الاسم، الهاتف، العنوان) تستخدم فقط لغرض توصيل الطلبية.</p>
            <p>لا يتم مشاركة بياناتكم مع أي طرف ثالث لأغراض إعلانية.</p>
        </div>
        <div id="content-contact">
            <h2>اتصل بنا</h2>
            <p>يسعدنا تواصلكم معنا عبر:</p>
            <p><i class="fas fa-phone"></i> الهاتف: 0550000000</p>
            <p><i class="fab fa-whatsapp"></i> واتساب: 0550000000</p>
            <p><i class="fas fa-envelope"></i> البريد: contact@store.dz</p>
            <p>أوقات العمل: من السبت إلى الخميس (9:00 - 18:00)</p>
        </div>
        <div id="content-about">
            <h2>من نحن</h2>
            <p>متجر إلكتروني جزائري رائد نسعى لتوفير تجربة تسوق ممتعة وسهلة.</p>
            <p>شعارنا المصداقية والجودة.</p>
        </div>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o",
            authDomain: "mourafik-e9161.firebaseapp.com",
            projectId: "mourafik-e9161",
            storageBucket: "mourafik-e9161.firebasestorage.app",
            messagingSenderId: "133465287328",
            appId: "1:133465287328:web:9de5b3bd709099d885b7c5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ALGERIA DATA (58 Wilayas) ---
        const wilayas = [
            "01 أدرار", "02 الشلف", "03 الأغواط", "04 أم البواقي", "05 باتنة", "06 بجاية", "07 بسكرة", "08 بشار",
            "09 البليدة", "10 البويرة", "11 تمنراست", "12 تبسة", "13 تلمسان", "14 تيارت", "15 تيزي وزو", "16 الجزائر",
            "17 الجلفة", "18 جيجل", "19 سطيف", "20 سعيدة", "21 سكيكدة", "22 سيدي بلعباس", "23 عنابة", "24 قالمة",
            "25 قسنطينة", "26 المدية", "27 مستغانم", "28 المسيلة", "29 معسكر", "30 ورقلة", "31 وهران", "32 البيض",
            "33 إليزي", "34 برج بوعريريج", "35 بومرداس", "36 الطارف", "37 تندوف", "38 تيسمسيلت", "39 الوادي",
            "40 خنشلة", "41 سوق أهراس", "42 تيبازة", "43 ميلة", "44 عين الدفلى", "45 النعامة", "46 عين تموشنت",
            "47 غرداية", "48 غليزان", "49 تيميمون", "50 برج باجي مختار", "51 أولاد جلال", "52 بني عباس",
            "53 عين صالح", "54 عين قزام", "55 تقرت", "56 جانت", "57 المغير", "58 المنيعة"
        ];

        window.loadWilayas = () => {
            const sel = document.getElementById('ord-wilaya');
            sel.innerHTML = '<option value="">-- اختر الولاية --</option>';
            wilayas.forEach(w => {
                sel.innerHTML += `<option value="${w}">${w}</option>`;
            });
        };

        // --- GLOBAL VARS ---
        let allProducts = [];
        let currentProd = null;

        // --- NAVIGATION ---
        window.nav = (view) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            if(view === 'admin') {
                if(localStorage.getItem('adminAuth')) document.getElementById('view-admin').classList.add('active');
                else document.getElementById('view-login').classList.add('active');
            } else {
                document.getElementById('view-' + view).classList.add('active');
                // Clean URL if going home
                if(view === 'home') {
                    history.pushState(null, null, window.location.pathname);
                }
            }
            window.scrollTo(0,0);
        };

        window.tab = (t) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            event.target.classList.add('active');
        };

        // --- AUTH ---
        window.login = () => {
            const u = document.getElementById('adm-user').value;
            const p = document.getElementById('adm-pass').value;
            if(u === 'admin' && p === 'abobob123') {
                localStorage.setItem('adminAuth', 'true');
                nav('admin');
            } else alert('خطأ في البيانات');
        };
        window.logout = () => { localStorage.removeItem('adminAuth'); nav('home'); };

        // --- MODALS ---
        window.showModal = (id) => {
            const content = document.getElementById('content-' + id).innerHTML;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').classList.add('active');
        };
        window.closeModal = () => {
            document.getElementById('modal-overlay').classList.remove('active');
        };
        document.getElementById('modal-overlay').onclick = (e) => {
            if(e.target === document.getElementById('modal-overlay')) closeModal();
        };

        // --- IMAGE HANDLER ---
        window.toggleImgInput = (type) => {
            if(type === 'url') {
                document.getElementById('new-img-url').style.display = 'block';
                document.getElementById('new-img-file').style.display = 'none';
            } else {
                document.getElementById('new-img-url').style.display = 'none';
                document.getElementById('new-img-file').style.display = 'block';
            }
        };

        window.convertBase64 = () => {
            const file = document.getElementById('new-img-file').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('final-img-data').value = e.target.result;
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('preview-img').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        // --- ADMIN: ADD / EDIT PRODUCT ---
        window.toggleClothType = () => {
            const check = document.getElementById('has-cloth-size').checked;
            document.getElementById('cloth-type-sel').style.display = check ? 'inline-block' : 'none';
        };
        
        document.getElementById('has-colors').addEventListener('change', (e) => {
            document.getElementById('color-list').style.display = e.target.checked ? 'block' : 'none';
            document.getElementById('color-hint').style.display = e.target.checked ? 'block' : 'none';
        });

        // Save (Add or Update)
        window.saveProduct = async () => {
            const id = document.getElementById('edit-prod-id').value;
            const isEdit = !!id;

            // Get Image
            let img = "";
            const imgType = document.querySelector('input[name="imgType"]:checked').value;
            
            if(imgType === 'url') img = document.getElementById('new-img-url').value;
            else img = document.getElementById('final-img-data').value;

            // If editing and no new image provided, keep old one? 
            // We need to fetch existing if image is empty in UI during edit.
            // Simplified: If edit and fields empty, we might overwrite. 
            // Better to assume user refills or we pre-fill. 
            // Logic below assumes form is pre-filled when editing starts.

            if(!document.getElementById('new-name').value || !document.getElementById('new-price').value) return alert("الاسم والسعر مطلوبان");
            if(!img && !isEdit) return alert("الصورة مطلوبة");
            
            // If editing and img is empty, we need the old image. 
            // The pre-fill logic puts URL in input. So we are good.

            const prodData = {
                name: document.getElementById('new-name').value,
                price: Number(document.getElementById('new-price').value),
                oldPrice: Number(document.getElementById('new-old-price').value) || 0,
                desc: document.getElementById('new-desc').value,
                image: img,
                date: new Date().toISOString(),
                hasShoeSize: document.getElementById('has-shoe-size').checked,
                hasClothSize: document.getElementById('has-cloth-size').checked,
                clothType: document.getElementById('cloth-type-sel').value,
                hasColors: document.getElementById('has-colors').checked,
                colorsList: document.getElementById('color-list').value
            };

            if(isEdit) {
                await updateDoc(doc(db, "products", id), prodData);
                alert("تم تعديل المنتج بنجاح");
            } else {
                await addDoc(collection(db, "products"), prodData);
                alert("تم إضافة المنتج بنجاح");
            }
            
            resetForm();
            nav('admin');
        };

        window.editP = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;

            document.getElementById('edit-prod-id').value = p.id;
            document.getElementById('form-title').innerText = "تعديل المنتج: " + p.name;
            document.getElementById('save-btn').innerText = "تحديث المنتج";
            document.getElementById('cancel-btn').style.display = "inline-block";

            document.getElementById('new-name').value = p.name;
            document.getElementById('new-price').value = p.price;
            document.getElementById('new-old-price').value = p.oldPrice || "";
            document.getElementById('new-desc').value = p.desc || "";
            
            // Image handling
            document.querySelector('input[name="imgType"][value="url"]').checked = true;
            toggleImgInput('url');
            document.getElementById('new-img-url').value = p.image;
            document.getElementById('preview-img').src = p.image;
            document.getElementById('preview-img').style.display = 'block';

            // Options
            document.getElementById('has-shoe-size').checked = p.hasShoeSize;
            document.getElementById('has-cloth-size').checked = p.hasClothSize;
            toggleClothType();
            document.getElementById('cloth-type-sel').value = p.clothType || "letters";
            document.getElementById('has-colors').checked = p.hasColors;
            document.getElementById('color-list').style.display = p.hasColors ? 'block' : 'none';
            document.getElementById('color-list').value = p.colorsList || "";

            document.querySelector('.admin-panel').scrollIntoView();
        };

        window.resetForm = () => {
            document.getElementById('edit-prod-id').value = "";
            document.getElementById('form-title').innerText = "إضافة منتج جديد";
            document.getElementById('save-btn').innerText = "حفظ ونشر";
            document.getElementById('cancel-btn').style.display = "none";
            
            // Clear inputs
            document.getElementById('new-name').value = "";
            document.getElementById('new-price').value = "";
            document.getElementById('new-old-price').value = "";
            document.getElementById('new-desc').value = "";
            document.getElementById('new-img-url').value = "";
            document.getElementById('final-img-data').value = "";
            document.getElementById('preview-img').style.display = "none";
            document.getElementById('has-shoe-size').checked = false;
            document.getElementById('has-cloth-size').checked = false;
            document.getElementById('has-colors').checked = false;
            document.getElementById('color-list').value = "";
            toggleClothType();
        };

        window.deleteP = async(id) => { if(confirm('هل أنت متأكد من حذف هذا المنتج؟')) await deleteDoc(doc(db, "products", id)); };
        window.deleteOrd = async(id) => { if(confirm('حذف الطلب؟')) await deleteDoc(doc(db, "orders", id)); };

        // --- APP LOGIC ---
        async function init() {
            loadWilayas();

            // Load Settings
            onSnapshot(doc(db, "settings", "main"), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    if(d.name) document.getElementById('store-title').innerText = d.name;
                    if(d.marquee) document.getElementById('marquee-txt').innerText = d.marquee;
                    if(d.theme) document.body.className = d.theme;
                    if(d.slider) {
                        const urls = d.slider.split('\n');
                        const sCont = document.getElementById('main-slider');
                        sCont.innerHTML = "";
                        urls.forEach((u, i) => {
                            if(u.trim()){
                                const div = document.createElement('div');
                                div.style = `position:absolute; width:100%; height:100%; background:url('${u.trim()}') center/cover; opacity:${i===0?1:0}; transition:1s;`;
                                div.className = 'slide-item';
                                sCont.appendChild(div);
                            }
                        });
                        startSlider();
                    }
                    // Admin Values
                    document.getElementById('set-name').value = d.name || "";
                    document.getElementById('set-marq').value = d.marquee || "";
                    document.getElementById('set-slider').value = d.slider || "";
                    document.getElementById('set-theme').value = d.theme || "theme-orange";
                }
            });

            // Load Products
            onSnapshot(query(collection(db, "products"), orderBy("date", "desc")), (snap) => {
                allProducts = [];
                const list = document.getElementById('products-list');
                const adminList = document.getElementById('admin-p-list');
                list.innerHTML = ""; adminList.innerHTML = "";

                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    allProducts.push(p);
                    
                    // Public List
                    renderProductCard(p, list);

                    // Admin List
                    adminList.innerHTML += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #eee; background:white;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <img src="${p.image}" width="50" height="50" style="object-fit:cover; border-radius:5px;">
                                <div>
                                    <b style="display:block;">${p.name}</b>
                                    <span style="font-size:0.9rem; color:#777;">${p.price} دج</span>
                                </div>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button onclick="editP('${p.id}')" class="btn btn-secondary" style="padding:5px 10px;">تعديل</button>
                                <button onclick="deleteP('${p.id}')" class="btn-danger" style="padding:5px 10px; border-radius:5px;">X</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('st-products').innerText = allProducts.length;

                // Check URL for direct product link (?product=ID)
                const urlParams = new URLSearchParams(window.location.search);
                const pId = urlParams.get('product');
                if(pId) {
                    const target = allProducts.find(p => p.id === pId);
                    if(target) openProduct(pId);
                }
            });

            // Load Orders (Admin)
            onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), (snap) => {
                const tb = document.getElementById('orders-tbody');
                tb.innerHTML = "";
                let revenue = 0;
                let count = 0;

                snap.forEach(d => {
                    const o = {id: d.id, ...d.data()};
                    revenue += Number(o.price);
                    count++;
                    const dt = new Date(o.date).toLocaleDateString('ar-DZ');
                    tb.innerHTML += `
                        <tr>
                            <td style="padding:10px;">${dt}</td>
                            <td style="padding:10px; text-align:right;">
                                <b>${o.custName}</b><br>${o.custPhone}<br>
                                <span style="font-size:0.8rem; color:#555;">${o.wilaya} - ${o.address}</span>
                            </td>
                            <td style="padding:10px;">
                                ${o.pName} <br>
                                ${(o.size || o.color) ? `<small style="background:#eee; padding:2px 5px; border-radius:3px;">${o.size} | ${o.color}</small>` : ''}
                            </td>
                            <td style="padding:10px; font-weight:bold; color:var(--main-color);">${o.price} دج</td>
                            <td><button onclick="deleteOrd('${o.id}')" class="btn-danger" style="padding:5px 8px; border-radius:3px;">X</button></td>
                        </tr>
                    `;
                });

                document.getElementById('st-orders').innerText = count;
                document.getElementById('st-revenue').innerText = revenue.toLocaleString();
            });
        }

        // --- RENDER HELPERS ---
        window.renderProductCard = (p, container) => {
            const discount = p.oldPrice ? Math.round(((p.oldPrice - p.price)/p.oldPrice)*100) : 0;
            container.innerHTML += `
                <div class="product-card" onclick="openProduct('${p.id}')">
                    <img src="${p.image}" class="p-img">
                    ${discount > 0 ? `<span style="position:absolute; top:10px; right:10px; background:#e74c3c; color:white; padding:2px 8px; border-radius:4px; font-weight:bold; font-size:0.8rem;">-${discount}%</span>` : ''}
                    <div class="p-info">
                        <h3 style="font-size:1rem; margin-bottom:5px;">${p.name}</h3>
                        <div class="price-box">
                            <span class="new-price">${p.price} دج</span>
                            ${p.oldPrice ? `<span class="old-price">${p.oldPrice}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        };

        window.filterProducts = () => {
            const txt = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('products-list');
            list.innerHTML = "";
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(txt));
            filtered.forEach(p => renderProductCard(p, list));
            if(filtered.length === 0) list.innerHTML = `<p style="text-align:center; width:100%;">لا توجد نتائج</p>`;
        };

        // --- SLIDER ANIM ---
        function startSlider(){
            let idx = 0;
            setInterval(() => {
                const slides = document.querySelectorAll('.slide-item');
                if(slides.length > 0) {
                    slides.forEach(s => s.style.opacity = 0);
                    idx = (idx + 1) % slides.length;
                    slides[idx].style.opacity = 1;
                }
            }, 4000);
        }

        // --- PRODUCT DETAILS ---
        window.openProduct = (id) => {
            currentProd = allProducts.find(p => p.id === id);
            if(!currentProd) return;

            // Change URL
            const newUrl = window.location.pathname + '?product=' + id;
            history.pushState({path: newUrl}, '', newUrl);

            // Fill Content
            const html = `
                <div style="display:flex; flex-wrap:wrap; gap:20px;">
                    <div style="flex:1; min-width:300px;">
                         <img src="${currentProd.image}" style="width:100%; border-radius:10px; border:1px solid #eee;">
                    </div>
                    <div style="flex:1; min-width:300px;">
                        <h1 style="font-size:1.8rem; margin-bottom:10px;">${currentProd.name}</h1>
                        <h2 style="color:var(--main-color); margin-bottom:20px; font-size:2rem;">${currentProd.price} دج</h2>
                        <div style="background:#f9f9f9; padding:15px; border-radius:8px; line-height:1.6; color:#555;">
                            ${(currentProd.desc || '').replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('p-detail-content').innerHTML = html;
            
            // Generate Selectors
            const container = document.getElementById('dynamic-selectors');
            container.innerHTML = "";

            // Sizes
            let sizes = [];
            if(currentProd.hasShoeSize) {
                sizes = [36,37,38,39,40,41,42,43,44,45];
            } else if (currentProd.hasClothSize) {
                if(currentProd.clothType === 'letters') sizes = ['S','M','L','XL','XXL','3XL'];
                else sizes = [36,38,40,42,44,46];
            }

            if(sizes.length > 0) {
                container.innerHTML += `<h4 style="margin-top:15px;">اختر المقاس:</h4><div class="options-container" id="size-opts"></div>`;
                const sizeDiv = document.getElementById('size-opts');
                sizes.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'circle-option';
                    div.innerText = s;
                    div.onclick = function() {
                        document.querySelectorAll('#size-opts .circle-option').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('ord-size').value = s;
                        updateSummary();
                    };
                    sizeDiv.appendChild(div);
                });
            } else {
                document.getElementById('ord-size').value = "Standard";
            }

            // Colors (Improved Visuals)
            if(currentProd.hasColors && currentProd.colorsList) {
                const cols = currentProd.colorsList.split(',').map(c => c.trim()).filter(c => c);
                if(cols.length > 0) {
                    container.innerHTML += `<h4 style="margin-top:15px;">اختر اللون:</h4><div class="options-container" id="col-opts"></div>`;
                    const colDiv = document.getElementById('col-opts');
                    
                    cols.forEach(c => {
                        const div = document.createElement('div');
                        
                        // Check if color is valid CSS to show as background
                        const isCssColor = (str) => {
                            const s = new Option().style;
                            s.color = str;
                            return s.color !== '';
                        };

                        if(isCssColor(c) || c.startsWith('#')) {
                            // Render as colored circle
                            div.className = 'color-circle';
                            div.style.backgroundColor = c;
                            div.title = c;
                        } else {
                            // Render as text circle
                            div.className = 'circle-option';
                            div.innerText = c;
                        }

                        div.onclick = function() {
                            document.querySelectorAll('#col-opts div').forEach(el => el.classList.remove('selected'));
                            this.classList.add('selected');
                            document.getElementById('ord-color').value = c;
                            updateSummary();
                        };
                        colDiv.appendChild(div);
                    });
                }
            } else {
                document.getElementById('ord-color').value = "Standard";
            }

            // Form Hidden Values
            document.getElementById('ord-pid').value = currentProd.id;
            document.getElementById('ord-pname').value = currentProd.name;
            document.getElementById('ord-price').value = currentProd.price;
            document.getElementById('ord-size').value = ""; 
            document.getElementById('ord-color').value = ""; 
            document.getElementById('order-summary').innerText = "...";
            
            nav('product');
        };

        window.updateSummary = () => {
            const s = document.getElementById('ord-size').value;
            const c = document.getElementById('ord-color').value;
            document.getElementById('order-summary').innerText = `المنتج: ${currentProd.name} | السعر: ${currentProd.price} دج \n المقاس: ${s || 'غير محدد'} | اللون: ${c || 'غير محدد'}`;
        };

        window.submitOrder = async (e) => {
            e.preventDefault();
            const p = currentProd;
            const s = document.getElementById('ord-size').value;
            const c = document.getElementById('ord-color').value;

            // Validation
            if((p.hasShoeSize || p.hasClothSize) && !s) return alert("يرجى اختيار المقاس من الخيارات المتاحة");
            if(p.hasColors && p.colorsList && !c) return alert("يرجى اختيار اللون");

            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الارسال...';

            const order = {
                pName: document.getElementById('ord-pname').value,
                price: document.getElementById('ord-price').value,
                custName: document.getElementById('ord-name').value,
                custPhone: document.getElementById('ord-phone').value,
                wilaya: document.getElementById('ord-wilaya').value,
                address: document.getElementById('ord-address').value,
                size: s,
                color: c,
                date: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, "orders"), order);
                alert("شكرا لك! تم استلام طلبك، سنتصل بك قريباً للتأكيد.");
                nav('home');
                e.target.reset();
            } catch (err) {
                alert("حدث خطأ، حاول مجدداً");
                console.error(err);
            }
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-check-circle"></i> تأكيد الطلب الآن';
        };

        window.saveSettings = async () => {
            const data = {
                name: document.getElementById('set-name').value,
                marquee: document.getElementById('set-marq').value,
                slider: document.getElementById('set-slider').value,
                theme: document.getElementById('set-theme').value
            };
            await setDoc(doc(db, "settings", "main"), data);
            alert("تم الحفظ");
            location.reload();
        };

        // Run
        init();
    </script>
</body>
</html>
