<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر الجزائري المحترف</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --main-color: #ff6600;
            --text-color: #333;
            --bg-color: #f4f6f8;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* Themes */
        body.theme-orange { --main-color: #ff6600; }
        body.theme-green { --main-color: #27ae60; }
        body.theme-blue { --main-color: #2980b9; }
        body.theme-purple { --main-color: #8e44ad; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        body { background-color: var(--bg-color); color: var(--text-color); padding-bottom: 60px;}
        a { text-decoration: none; color: inherit; }
        
        /* --- General UI --- */
        .btn { cursor: pointer; padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--main-color); color: white; width: 100%; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { opacity: 0.9; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; background: #fff; }

        /* --- Circles Options (Sizes/Colors) --- */
        .options-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; margin-bottom: 15px; }
        .circle-option {
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            border: 2px solid #ddd; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 0.9rem;
            transition: 0.2s; background: white; user-select: none;
        }
        .circle-option:hover { border-color: var(--main-color); }
        .circle-option.selected { background-color: var(--main-color); color: white; border-color: var(--main-color); transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        
        /* For Colors specific */
        .color-option { border-radius: 50%; width: 40px; height: 40px; border: 2px solid #ddd; cursor: pointer; }
        .color-option.selected { border: 3px solid var(--main-color); transform: scale(1.1); }

        /* --- Header & Layout --- */
        header { background: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo-area h2 { color: var(--main-color); font-weight: 800; }
        .nav-icons { display: flex; gap: 15px; font-size: 1.2rem; color: #555; }
        
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Product Grid --- */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; max-width: 1200px; margin: auto; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); } }
        
        .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: 0.3s; }
        .product-card:hover { transform: translateY(-5px); }
        .p-img { width: 100%; height: 180px; object-fit: cover; }
        .p-info { padding: 10px; }
        .price-box { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .new-price { color: var(--main-color); font-weight: bold; font-size: 1.1rem; }
        .old-price { text-decoration: line-through; color: #999; font-size: 0.8rem; }

        /* --- Product Details --- */
        .product-view-container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; }
        
        /* --- Admin --- */
        .admin-panel { padding: 20px; max-width: 1000px; margin: auto; }
        .admin-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { background: #eee; padding: 10px 20px; border: none; cursor: pointer; }
        .tab-btn.active { background: var(--main-color); color: white; }
        .admin-content { display: none; }
        .admin-content.active { display: block; }
        
        /* --- Toggle Switch --- */
        .toggle-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 5px;}
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--main-color); }
        input:checked + .slider:before { transform: translateX(26px); }

    </style>
</head>
<body class="theme-orange">

    <!-- Header -->
    <header>
        <div class="logo-area">
            <h2 id="store-title">اسم المتجر</h2>
        </div>
        <div class="nav-icons">
            <i class="fas fa-home" onclick="nav('home')"></i>
            <i class="fas fa-user-cog" onclick="nav('admin')"></i>
        </div>
    </header>

    <!-- HOME VIEW -->
    <div id="view-home" class="page-section active">
        <!-- Slider -->
        <div style="position: relative; height: 250px; overflow: hidden;" id="main-slider">
            <!-- JS will populate this -->
        </div>

        <!-- Marquee -->
        <div style="background: var(--main-color); color: white; padding: 8px; overflow: hidden; white-space: nowrap;">
            <div style="display: inline-block; animation: marquee 15s linear infinite; font-weight: bold;" id="marquee-txt">
                عرض خاص وحصري - التوصيل متوفر لـ 58 ولاية والدفع عند الاستلام
            </div>
            <style>@keyframes marquee { 0% { transform: translateX(-100vw); } 100% { transform: translateX(100vw); } }</style>
        </div>

        <!-- Products -->
        <h2 style="text-align: center; margin: 20px 0;">أحدث المنتجات</h2>
        <div class="grid" id="products-list">
            <!-- Products injected here -->
            <p style="text-align:center; width:200%;">جاري التحميل...</p>
        </div>
    </div>

    <!-- PRODUCT DETAIL VIEW -->
    <div id="view-product" class="page-section">
        <div class="product-view-container">
            <button onclick="nav('home')" style="background:none; border:none; color:#777; margin-bottom:10px; cursor:pointer;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <div id="p-detail-content"></div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <form id="order-form" onsubmit="submitOrder(event)">
                <h3 style="color: var(--main-color); margin-bottom: 15px;">استمارة الطلب</h3>
                
                <!-- Hidden inputs -->
                <input type="hidden" id="ord-pid">
                <input type="hidden" id="ord-pname">
                <input type="hidden" id="ord-price">
                <input type="hidden" id="ord-size" value="">
                <input type="hidden" id="ord-color" value="">

                <!-- Customer Info -->
                <label>الاسم واللقب:</label>
                <input type="text" id="ord-name" required placeholder="أدخل اسمك الكامل">
                
                <label>رقم الهاتف:</label>
                <input type="tel" id="ord-phone" required placeholder="05/06/07...">

                <label>الولاية:</label>
                <select id="ord-wilaya" onchange="loadCommunes()" required>
                    <option value="">-- اختر الولاية --</option>
                </select>

                <label>البلدية:</label>
                <select id="ord-commune" required disabled>
                    <option value="">-- اختر البلدية أولاً --</option>
                </select>

                <!-- Dynamic Options Selection -->
                <div id="dynamic-selectors"></div>

                <div style="margin-top: 20px; background: #e8f5e9; padding: 15px; border-radius: 5px;">
                    <p style="font-weight: bold;">ملخص الطلب:</p>
                    <p id="order-summary">...</p>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 20px;">تأكيد الطلب الآن</button>
            </form>
        </div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="view-login" class="page-section">
        <div style="max-width:350px; margin: 50px auto; padding: 30px; background: white; text-align: center; box-shadow: var(--shadow);">
            <h3>دخول المدير</h3>
            <input type="text" id="adm-user" placeholder="User">
            <input type="password" id="adm-pass" placeholder="Pass">
            <button onclick="login()" class="btn btn-primary">دخول</button>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="view-admin" class="page-section">
        <div class="admin-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>لوحة التحكم</h2>
                <button onclick="logout()" class="btn btn-danger" style="width:auto;">خروج</button>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" onclick="tab('orders')">الطلبات</button>
                <button class="tab-btn" onclick="tab('products')">إضافة منتج</button>
                <button class="tab-btn" onclick="tab('list')">قائمة المنتجات</button>
                <button class="tab-btn" onclick="tab('settings')">الإعدادات</button>
            </div>

            <!-- Orders Tab -->
            <div id="tab-orders" class="admin-content active">
                <table style="width:100%; border-collapse:collapse;" border="1" bordercolor="#eee">
                    <thead style="background:#f9f9f9;">
                        <tr>
                            <th>التاريخ</th>
                            <th>معلومات الزبون</th>
                            <th>المنتج</th>
                            <th>الخيارات</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody"></tbody>
                </table>
            </div>

            <!-- Add Product Tab -->
            <div id="tab-products" class="admin-content">
                <div style="background:white; padding:20px; border-radius:8px;">
                    <h3>إضافة منتج جديد</h3>
                    <input type="text" id="new-name" placeholder="اسم المنتج">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="new-price" placeholder="السعر (دج)">
                        <input type="number" id="new-old-price" placeholder="السعر القديم (اختياري)">
                    </div>
                    <textarea id="new-desc" placeholder="وصف المنتج" rows="3"></textarea>
                    
                    <!-- Image Selection -->
                    <div style="margin-bottom:15px; border:1px solid #eee; padding:10px;">
                        <label>صورة المنتج:</label><br>
                        <input type="radio" name="imgType" value="url" checked onclick="toggleImgInput('url')"> رابط
                        <input type="radio" name="imgType" value="file" onclick="toggleImgInput('file')"> رفع ملف
                        
                        <input type="text" id="new-img-url" placeholder="https://example.com/image.jpg" style="margin-top:5px;">
                        <input type="file" id="new-img-file" style="display:none; margin-top:5px;" accept="image/*" onchange="convertBase64()">
                        <input type="hidden" id="final-img-data">
                    </div>

                    <!-- Options Toggles -->
                    <div class="toggle-wrapper">
                        <label class="switch"><input type="checkbox" id="has-shoe-size"><span class="slider"></span></label>
                        <span>تفعيل مقاسات الأحذية (36 - 45)</span>
                    </div>

                    <div class="toggle-wrapper">
                        <label class="switch"><input type="checkbox" id="has-cloth-size" onchange="toggleClothType()"><span class="slider"></span></label>
                        <span>تفعيل مقاسات الملابس</span>
                        <select id="cloth-type-sel" style="width:auto; margin:0 10px; display:none;">
                            <option value="letters">أحرف (S, M, L...)</option>
                            <option value="numbers">أرقام (36, 38, 40...)</option>
                        </select>
                    </div>

                    <div class="toggle-wrapper">
                        <label class="switch"><input type="checkbox" id="has-colors"><span class="slider"></span></label>
                        <span>تفعيل الألوان</span>
                    </div>
                    <input type="text" id="color-list" placeholder="اكتب الألوان مفصولة بفاصلة (مثال: أحمر, أزرق, أسود)" style="display:none;">

                    <button onclick="addProduct()" class="btn btn-primary">حفظ ونشر المنتج</button>
                </div>
            </div>

            <!-- Product List Tab -->
            <div id="tab-list" class="admin-content">
                <div id="admin-p-list"></div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="admin-content">
                <label>اسم المتجر:</label> <input type="text" id="set-name">
                <label>شريط العروض (Marquee):</label> <input type="text" id="set-marq">
                <label>روابط صور السلايدر (رابط في كل سطر):</label> 
                <textarea id="set-slider" rows="5" placeholder="https://img1.jpg&#10;https://img2.jpg"></textarea>
                <label>لون المتجر (Theme):</label>
                <select id="set-theme">
                    <option value="theme-orange">برتقالي</option>
                    <option value="theme-green">أخضر</option>
                    <option value="theme-blue">أزرق</option>
                    <option value="theme-purple">بنفسجي</option>
                </select>
                <button onclick="saveSettings()" class="btn btn-primary">حفظ الإعدادات</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o",
            authDomain: "mourafik-e9161.firebaseapp.com",
            projectId: "mourafik-e9161",
            storageBucket: "mourafik-e9161.firebasestorage.app",
            messagingSenderId: "133465287328",
            appId: "1:133465287328:web:9de5b3bd709099d885b7c5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ALGERIA DATA (Wilayas & Communes Snippet) ---
        // لتحسين الأداء سأضع البيانات التي قدمتها، يمكنك إضافة البقية بنفس النمط
        const dzData = [
            { code: "01", name: "أدرار", communes: ["أدرار", "تامنطيت", "أولف", "رقان"] },
            { code: "02", name: "الشلف", communes: ["الشلف", "تنس", "بوقادير"] },
            { code: "03", name: "الأغواط", communes: ["الأغواط", "قصر الحيران", "عين ماضي"] },
            // ... يمكنك نسخ باقي الملف هنا بنفس الهيكلة
            // مثال لإضافة البقية: { code: "04", name: "أم البواقي", communes: ["..."] },
        ];

        window.loadWilayas = () => {
            const sel = document.getElementById('ord-wilaya');
            sel.innerHTML = '<option value="">-- اختر الولاية --</option>';
            dzData.forEach(w => {
                sel.innerHTML += `<option value="${w.code}">${w.code} - ${w.name}</option>`;
            });
        };

        window.loadCommunes = () => {
            const wCode = document.getElementById('ord-wilaya').value;
            const comSel = document.getElementById('ord-commune');
            comSel.innerHTML = '<option value="">-- اختر البلدية --</option>';
            
            if(wCode) {
                const wilaya = dzData.find(w => w.code === wCode);
                if(wilaya) {
                    wilaya.communes.forEach(c => {
                        comSel.innerHTML += `<option value="${c}">${c}</option>`;
                    });
                    comSel.disabled = false;
                }
            } else {
                comSel.disabled = true;
            }
        };

        // --- GLOBAL VARS ---
        let products = [];
        let currentProd = null;

        // --- NAVIGATION ---
        window.nav = (view) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            if(view === 'admin') {
                if(localStorage.getItem('adminAuth')) document.getElementById('view-admin').classList.add('active');
                else document.getElementById('view-login').classList.add('active');
            } else {
                document.getElementById('view-' + view).classList.add('active');
            }
            window.scrollTo(0,0);
        };

        window.tab = (t) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            event.target.classList.add('active');
        };

        // --- AUTH ---
        window.login = () => {
            const u = document.getElementById('adm-user').value;
            const p = document.getElementById('adm-pass').value;
            if(u === 'admin' && p === 'abobob123') {
                localStorage.setItem('adminAuth', 'true');
                nav('admin');
            } else alert('خطأ في البيانات');
        };
        window.logout = () => { localStorage.removeItem('adminAuth'); nav('home'); };

        // --- IMAGE HANDLER ---
        window.toggleImgInput = (type) => {
            if(type === 'url') {
                document.getElementById('new-img-url').style.display = 'block';
                document.getElementById('new-img-file').style.display = 'none';
            } else {
                document.getElementById('new-img-url').style.display = 'none';
                document.getElementById('new-img-file').style.display = 'block';
            }
        };

        window.convertBase64 = () => {
            const file = document.getElementById('new-img-file').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('final-img-data').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        // --- ADMIN: ADD PRODUCT LOGIC ---
        // Toggle helper
        window.toggleClothType = () => {
            const check = document.getElementById('has-cloth-size').checked;
            document.getElementById('cloth-type-sel').style.display = check ? 'inline-block' : 'none';
        };
        
        document.getElementById('has-colors').addEventListener('change', (e) => {
            document.getElementById('color-list').style.display = e.target.checked ? 'block' : 'none';
        });

        window.addProduct = async () => {
            // Get Image
            let img = "";
            const imgType = document.querySelector('input[name="imgType"]:checked').value;
            if(imgType === 'url') img = document.getElementById('new-img-url').value;
            else img = document.getElementById('final-img-data').value;

            if(!document.getElementById('new-name').value || !document.getElementById('new-price').value) return alert("الاسم والسعر مطلوبان");

            const newProd = {
                name: document.getElementById('new-name').value,
                price: document.getElementById('new-price').value,
                oldPrice: document.getElementById('new-old-price').value,
                desc: document.getElementById('new-desc').value,
                image: img,
                date: new Date().toISOString(),
                // Options Config
                hasShoeSize: document.getElementById('has-shoe-size').checked,
                hasClothSize: document.getElementById('has-cloth-size').checked,
                clothType: document.getElementById('cloth-type-sel').value,
                hasColors: document.getElementById('has-colors').checked,
                colorsList: document.getElementById('color-list').value
            };

            await addDoc(collection(db, "products"), newProd);
            alert("تمت الإضافة بنجاح");
            nav('admin');
        };

        window.deleteP = async(id) => { if(confirm('حذف؟')) await deleteDoc(doc(db, "products", id)); };

        // --- APP LOGIC ---
        async function init() {
            loadWilayas();

            // Load Settings
            onSnapshot(doc(db, "settings", "main"), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    if(d.name) document.getElementById('store-title').innerText = d.name;
                    if(d.marquee) document.getElementById('marquee-txt').innerText = d.marquee;
                    if(d.theme) document.body.className = d.theme;
                    if(d.slider) {
                        const urls = d.slider.split('\n');
                        const sCont = document.getElementById('main-slider');
                        sCont.innerHTML = "";
                        urls.forEach((u, i) => {
                            if(u.trim()){
                                const div = document.createElement('div');
                                div.style = `position:absolute; width:100%; height:100%; background:url('${u.trim()}') center/cover; opacity:${i===0?1:0}; transition:1s;`;
                                div.className = 'slide-item';
                                sCont.appendChild(div);
                            }
                        });
                        startSlider();
                    }
                    // Fill admin inputs
                    document.getElementById('set-name').value = d.name || "";
                    document.getElementById('set-marq').value = d.marquee || "";
                    document.getElementById('set-slider').value = d.slider || "";
                    document.getElementById('set-theme').value = d.theme || "theme-orange";
                }
            });

            // Load Products
            onSnapshot(query(collection(db, "products"), orderBy("date", "desc")), (snap) => {
                products = [];
                const list = document.getElementById('products-list');
                const adminList = document.getElementById('admin-p-list');
                list.innerHTML = ""; adminList.innerHTML = "";

                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    products.push(p);
                    
                    // User Card
                    const discount = p.oldPrice ? Math.round(((p.oldPrice - p.price)/p.oldPrice)*100) : 0;
                    list.innerHTML += `
                        <div class="product-card" onclick="openProduct('${p.id}')">
                            <img src="${p.image}" class="p-img">
                            ${discount ? `<span style="position:absolute; top:10px; right:10px; background:red; color:white; padding:2px 5px; border-radius:3px;">-${discount}%</span>` : ''}
                            <div class="p-info">
                                <h3>${p.name}</h3>
                                <div class="price-box">
                                    <span class="new-price">${p.price} دج</span>
                                    ${p.oldPrice ? `<span class="old-price">${p.oldPrice}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    // Admin List Item
                    adminList.innerHTML += `
                        <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${p.image}" width="40" height="40" style="object-fit:cover; border-radius:4px;">
                                <b>${p.name}</b>
                            </div>
                            <button onclick="deleteP('${p.id}')" class="btn-danger" style="padding:5px 10px; border:none; border-radius:3px;">X</button>
                        </div>
                    `;
                });
            });

            // Load Orders (Admin)
            onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), (snap) => {
                const tb = document.getElementById('orders-tbody');
                tb.innerHTML = "";
                snap.forEach(d => {
                    const o = d.data();
                    const dt = new Date(o.date).toLocaleDateString('ar-DZ');
                    tb.innerHTML += `
                        <tr>
                            <td>${dt}</td>
                            <td>${o.custName}<br>${o.custPhone}<br>${o.wilaya} - ${o.commune}</td>
                            <td>${o.pName}<br><small style="color:var(--main-color)">${o.size} / ${o.color}</small></td>
                            <td>${o.price} دج</td>
                        </tr>
                    `;
                });
            });
        }

        // --- SLIDER ANIM ---
        function startSlider(){
            let idx = 0;
            setInterval(() => {
                const slides = document.querySelectorAll('.slide-item');
                if(slides.length > 0) {
                    slides.forEach(s => s.style.opacity = 0);
                    idx = (idx + 1) % slides.length;
                    slides[idx].style.opacity = 1;
                }
            }, 3000);
        }

        // --- PRODUCT DETAILS & SELECTION LOGIC ---
        window.openProduct = (id) => {
            currentProd = products.find(p => p.id === id);
            if(!currentProd) return;

            // Fill Data
            const html = `
                <img src="${currentProd.image}" style="width:100%; max-height:350px; object-fit:contain; border-radius:8px;">
                <h1 style="margin-top:10px;">${currentProd.name}</h1>
                <p style="color:#666;">${currentProd.desc || ''}</p>
                <h2 style="color:var(--main-color); margin:10px 0;">${currentProd.price} دج</h2>
            `;
            document.getElementById('p-detail-content').innerHTML = html;
            
            // Generate Selectors (Circles)
            const container = document.getElementById('dynamic-selectors');
            container.innerHTML = "";

            // 1. Sizes
            let sizes = [];
            if(currentProd.hasShoeSize) {
                sizes = [36,37,38,39,40,41,42,43,44,45];
            } else if (currentProd.hasClothSize) {
                if(currentProd.clothType === 'letters') sizes = ['S','M','L','XL','XXL','3XL'];
                else sizes = [36,38,40,42,44,46];
            }

            if(sizes.length > 0) {
                container.innerHTML += `<h4>اختر المقاس:</h4><div class="options-container" id="size-opts"></div>`;
                const sizeDiv = document.getElementById('size-opts');
                sizes.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'circle-option';
                    div.innerText = s;
                    div.onclick = function() {
                        document.querySelectorAll('#size-opts .circle-option').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('ord-size').value = s;
                        updateSummary();
                    };
                    sizeDiv.appendChild(div);
                });
            } else {
                document.getElementById('ord-size').value = "Standard";
            }

            // 2. Colors
            if(currentProd.hasColors && currentProd.colorsList) {
                const cols = currentProd.colorsList.split(',').map(c => c.trim());
                container.innerHTML += `<h4>اختر اللون:</h4><div class="options-container" id="col-opts"></div>`;
                const colDiv = document.getElementById('col-opts');
                cols.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'circle-option'; // Default circle style
                    
                    // Try to see if it's a valid CSS color for background
                    // To keep it simple, we just show text inside circle, 
                    // or if user wants real color preview they need to enter hex codes.
                    // Here we will display text inside.
                    div.innerText = c;
                    div.style.width = "auto"; 
                    div.style.padding = "0 10px";
                    
                    div.onclick = function() {
                        document.querySelectorAll('#col-opts .circle-option').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('ord-color').value = c;
                        updateSummary();
                    };
                    colDiv.appendChild(div);
                });
            } else {
                document.getElementById('ord-color').value = "Standard";
            }

            // Form Hidden
            document.getElementById('ord-pid').value = currentProd.id;
            document.getElementById('ord-pname').value = currentProd.name;
            document.getElementById('ord-price').value = currentProd.price;
            document.getElementById('ord-size').value = ""; // Reset
            document.getElementById('ord-color').value = ""; // Reset
            
            nav('product');
        };

        window.updateSummary = () => {
            const s = document.getElementById('ord-size').value;
            const c = document.getElementById('ord-color').value;
            document.getElementById('order-summary').innerText = `المنتج: ${currentProd.name} | المقاس: ${s || 'غير محدد'} | اللون: ${c || 'غير محدد'}`;
        };

        window.submitOrder = async (e) => {
            e.preventDefault();
            const p = currentProd;
            const s = document.getElementById('ord-size').value;
            const c = document.getElementById('ord-color').value;

            // Validation
            if((p.hasShoeSize || p.hasClothSize) && !s) return alert("يرجى اختيار المقاس");
            if(p.hasColors && !c) return alert("يرجى اختيار اللون");

            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerText = "جاري الارسال...";

            const order = {
                pName: document.getElementById('ord-pname').value,
                price: document.getElementById('ord-price').value,
                custName: document.getElementById('ord-name').value,
                custPhone: document.getElementById('ord-phone').value,
                wilaya: document.getElementById('ord-wilaya').options[document.getElementById('ord-wilaya').selectedIndex].text,
                commune: document.getElementById('ord-commune').value,
                size: s,
                color: c,
                date: new Date().toISOString()
            };

            await addDoc(collection(db, "orders"), order);
            alert("شكرا لك! تم استلام طلبك");
            nav('home');
            btn.disabled = false; btn.innerText = "تأكيد الطلب";
            e.target.reset();
        };

        window.saveSettings = async () => {
            const data = {
                name: document.getElementById('set-name').value,
                marquee: document.getElementById('set-marq').value,
                slider: document.getElementById('set-slider').value,
                theme: document.getElementById('set-theme').value
            };
            await setDoc(doc(db, "settings", "main"), data);
            alert("تم الحفظ");
            location.reload();
        };

        // Run
        init();
    </script>
</body>
</html>
