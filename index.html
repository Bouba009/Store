<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر الجزائري المحترف</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --main-color: #ff6600;
            --text-color: #333;
            --bg-color: #f4f6f8;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --radius: 12px;
        }

        body.theme-orange { --main-color: #ff6600; }
        body.theme-green { --main-color: #27ae60; }
        body.theme-blue { --main-color: #2980b9; }
        body.theme-purple { --main-color: #8e44ad; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        body { background-color: var(--bg-color); color: var(--text-color); padding-bottom: 60px; line-height: 1.6;}
        a { text-decoration: none; color: inherit; }
        
        /* --- General UI --- */
        .btn { cursor: pointer; padding: 12px 25px; border-radius: var(--radius); border: none; font-weight: bold; transition: 0.3s; font-size: 1rem; }
        .btn-primary { background: var(--main-color); color: white; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        /* --- Modern Form Inputs --- */
        .input-group { margin-bottom: 15px; text-align: right; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #555; font-size: 0.9rem; }
        .input-group input, .input-group select, .input-group textarea { 
            width: 100%; padding: 12px 15px; border: 2px solid #eee; border-radius: var(--radius); 
            background: #fff; transition: 0.3s; font-size: 1rem;
        }
        .input-group input:focus { border-color: var(--main-color); box-shadow: 0 0 0 4px rgba(255,102,0,0.1); }

        /* --- Circles Options --- */
        .options-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; margin-bottom: 20px; }
        .circle-option {
            min-width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            border: 2px solid #eee; border-radius: var(--radius); cursor: pointer; font-weight: bold;
            transition: 0.2s; background: white; user-select: none; padding: 0 10px;
        }
        .circle-option.selected { background-color: var(--main-color); color: white; border-color: var(--main-color); transform: scale(1.05); }

        /* --- Header --- */
        header { background: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
        .logo-area h2 { color: var(--main-color); font-weight: 800; }
        .nav-icons { display: flex; gap: 20px; font-size: 1.3rem; color: #555; }
        .nav-icons i { cursor: pointer; transition: 0.3s; }
        .nav-icons i:hover { color: var(--main-color); }
        
        .page-section { display: none; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Grid --- */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; max-width: 1200px; margin: auto; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); } }
        
        .product-card { background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: 0.3s; position: relative;}
        .p-img { width: 100%; height: 200px; object-fit: cover; }
        .p-info { padding: 15px; }
        .new-price { color: var(--main-color); font-weight: 800; font-size: 1.2rem; }
        .old-price { text-decoration: line-through; color: #999; font-size: 0.9rem; margin-right: 8px; }

        /* --- Modern Order Form --- */
        .order-card { background: #fff; border: 1px solid #eee; border-radius: var(--radius); padding: 25px; margin-top: 20px; box-shadow: var(--shadow); }
        .summary-box { background: #fdf2e9; border-right: 5px solid var(--main-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; }

        /* --- Admin --- */
        .admin-panel { padding: 20px; max-width: 1000px; margin: auto; }
        .admin-tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { background: #eee; padding: 10px 20px; border: none; cursor: pointer; border-radius: 5px; white-space: nowrap; }
        .tab-btn.active { background: var(--main-color); color: white; }
        .admin-content { display: none; background: white; padding: 20px; border-radius: var(--radius); }
        .admin-content.active { display: block; }
    </style>
</head>
<body class="theme-orange">

    <header>
        <div class="logo-area" onclick="nav('home')" style="cursor:pointer">
            <h2 id="store-title">اسم المتجر</h2>
        </div>
        <div class="nav-icons">
            <i class="fas fa-home" onclick="nav('home')"></i>
            <i class="fas fa-user-cog" onclick="nav('admin')"></i>
        </div>
    </header>

    <!-- HOME VIEW -->
    <div id="view-home" class="page-section active">
        <div style="position: relative; height: 280px; overflow: hidden; border-radius: 0 0 20px 20px;" id="main-slider"></div>
        
        <div style="background: var(--main-color); color: white; padding: 10px; overflow: hidden; white-space: nowrap; font-size: 0.9rem;">
            <div style="display: inline-block; animation: marquee 20s linear infinite; font-weight: bold;" id="marquee-txt">
                عرض خاص وحصري - التوصيل متوفر لـ 58 ولاية والدفع عند الاستلام
            </div>
        </div>

        <h2 style="text-align: center; margin: 30px 0 10px;">أحدث المنتجات</h2>
        <div class="grid" id="products-list"></div>
    </div>

    <!-- PRODUCT DETAIL VIEW -->
    <div id="view-product" class="page-section">
        <div style="max-width: 800px; margin: 20px auto; padding: 0 15px;">
            <button onclick="nav('home')" style="background:none; border:none; color:var(--main-color); margin-bottom:15px; cursor:pointer; font-weight:bold; font-size:1rem;">
                <i class="fas fa-arrow-right"></i> العودة للمتجر
            </button>
            
            <div id="p-detail-content" style="background:white; padding:20px; border-radius:var(--radius); box-shadow: var(--shadow);"></div>

            <div class="order-card">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-shopping-cart" style="color:var(--main-color)"></i> تأكيد الطلب
                </h3>
                
                <form id="order-form" onsubmit="submitOrder(event)">
                    <input type="hidden" id="ord-size">
                    <input type="hidden" id="ord-color">

                    <div id="dynamic-selectors"></div>

                    <div class="summary-box" id="summary-area" style="display:none;">
                        <p style="font-weight: bold; color: var(--main-color);">ملخص الاختيار:</p>
                        <p id="order-summary">يرجى اختيار المقاس واللون</p>
                    </div>

                    <div class="input-group">
                        <label>الاسم الكامل:</label>
                        <input type="text" id="ord-name" required placeholder="مثال: محمد أحمد">
                    </div>
                    
                    <div class="input-group">
                        <label>رقم الهاتف:</label>
                        <input type="tel" id="ord-phone" required placeholder="05 / 06 / 07XXXXXXXX">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="input-group">
                            <label>الولاية:</label>
                            <select id="ord-wilaya" onchange="loadCommunes()" required></select>
                        </div>
                        <div class="input-group">
                            <label>البلدية:</label>
                            <select id="ord-commune" required disabled>
                                <option value="">اختر الولاية أولاً</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="margin-top: 15px; font-size: 1.2rem; padding: 15px;">
                        إرسال الطلب الآن
                    </button>
                    <p style="text-align: center; font-size: 0.8rem; color: #777; margin-top: 10px;">الدفع يكون عند الاستلام يد بيد</p>
                </form>
            </div>
        </div>
    </div>

    <!-- ADMIN & LOGIN (Same as before but with minor styling) -->
    <div id="view-login" class="page-section">
        <div style="max-width:350px; margin: 80px auto; padding: 30px; background: white; text-align: center; box-shadow: var(--shadow); border-radius:var(--radius);">
            <h3>دخول الإدارة</h3><br>
            <div class="input-group"><input type="text" id="adm-user" placeholder="اسم المستخدم"></div>
            <div class="input-group"><input type="password" id="adm-pass" placeholder="كلمة المرور"></div>
            <button onclick="login()" class="btn btn-primary">دخول</button>
        </div>
    </div>

    <div id="view-admin" class="page-section">
        <div class="admin-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>لوحة التحكم</h2>
                <button onclick="logout()" class="btn btn-danger" style="padding:8px 15px;">خروج</button>
            </div>
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="tab('orders')">الطلبات</button>
                <button class="tab-btn" onclick="tab('products')">إضافة منتج</button>
                <button class="tab-btn" onclick="tab('list')">المنتجات</button>
                <button class="tab-btn" onclick="tab('settings')">الإعدادات</button>
            </div>
            <div id="tab-orders" class="admin-content active"><table style="width:100%; text-align:right;" border="1" cellpadding="10" cellspacing="0" id="orders-table"><thead><tr style="background:#eee"><th>الزبون</th><th>المنتج</th><th>السعر</th></tr></thead><tbody id="orders-tbody"></tbody></table></div>
            <div id="tab-products" class="admin-content">
                <div class="input-group"><label>اسم المنتج</label><input type="text" id="new-name"></div>
                <div style="display:flex; gap:10px;"><div class="input-group"><label>السعر</label><input type="number" id="new-price"></div><div class="input-group"><label>السعر القديم</label><input type="number" id="new-old-price"></div></div>
                <div class="input-group"><label>وصف المنتج</label><textarea id="new-desc"></textarea></div>
                <div class="input-group"><label>رابط الصورة</label><input type="text" id="new-img-url"></div>
                <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <p><b>خيارات المنتج:</b></p>
                    <label><input type="checkbox" id="has-shoe-size"> مقاسات أحذية</label><br>
                    <label><input type="checkbox" id="has-cloth-size"> مقاسات ملابس</label>
                    <select id="cloth-type-sel"><option value="letters">S-XXL</option><option value="numbers">36-46</option></select><br>
                    <label><input type="checkbox" id="has-colors"> تفعيل الألوان</label>
                    <input type="text" id="color-list" placeholder="أحمر, أزرق, أسود">
                </div>
                <button onclick="addProduct()" class="btn btn-primary">نشر المنتج</button>
            </div>
            <div id="tab-list" class="admin-content"><div id="admin-p-list"></div></div>
            <div id="tab-settings" class="admin-content">
                 <div class="input-group"><label>اسم المتجر</label><input type="text" id="set-name"></div>
                 <div class="input-group"><label>شريط العروض</label><input type="text" id="set-marq"></div>
                 <div class="input-group"><label>الصور (روابط)</label><textarea id="set-slider"></textarea></div>
                 <button onclick="saveSettings()" class="btn btn-primary">حفظ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o",
            authDomain: "mourafik-e9161.firebaseapp.com",
            projectId: "mourafik-e9161",
            storageBucket: "mourafik-e9161.firebasestorage.app",
            messagingSenderId: "133465287328",
            appId: "1:133465287328:web:9de5b3bd709099d885b7c5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const dzData = [
            { code: "01", name: "أدرار", communes: ["أدرار", "أولف", "رقان"] },
            { code: "02", name: "الشلف", communes: ["الشلف", "تنس", "بوقادير"] },
            { code: "06", name: "بجاية", communes: ["بجاية", "أقبو", "القصر"] },
            { code: "09", name: "البليدة", communes: ["البليدة", "بوفاريك", "العفرون"] },
            { code: "16", name: "الجزائر العاصمة", communes: ["الرويبة", "باب الزوار", "الشراقة", "القبة"] },
            { code: "19", name: "سطيف", communes: ["سطيف", "العلمة", "عين أرنات"] },
            { code: "31", name: "وهران", communes: ["وهران", "عين الترك", "السانيا"] }
            // يمكن إضافة البقية هنا
        ];

        let products = [];
        let currentProd = null;

        // --- Routing Logic ---
        window.nav = (view, prodName = null) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            
            if(view === 'product' && prodName) {
                const cleanName = decodeURIComponent(prodName).replace(/-/g, ' ');
                const p = products.find(item => item.name === cleanName);
                if(p) {
                    currentProd = p;
                    renderProductPage(p);
                    window.history.pushState({view: 'product', name: prodName}, "", `/product/${prodName}`);
                    document.getElementById('view-product').classList.add('active');
                } else {
                    nav('home');
                }
            } else if(view === 'admin') {
                if(localStorage.getItem('adminAuth')) document.getElementById('view-admin').classList.add('active');
                else document.getElementById('view-login').classList.add('active');
            } else {
                window.history.pushState({view: 'home'}, "", "/");
                document.getElementById('view-home').classList.add('active');
            }
            window.scrollTo(0,0);
        };

        window.onpopstate = (e) => {
            if(e.state && e.state.view === 'product') nav('product', e.state.name);
            else nav('home');
        };

        // --- Core Functions ---
        window.loadWilayas = () => {
            const sel = document.getElementById('ord-wilaya');
            sel.innerHTML = '<option value="">اختر الولاية</option>';
            dzData.forEach(w => sel.innerHTML += `<option value="${w.code}">${w.code}-${w.name}</option>`);
        };

        window.loadCommunes = () => {
            const wCode = document.getElementById('ord-wilaya').value;
            const comSel = document.getElementById('ord-commune');
            comSel.innerHTML = '<option value="">اختر البلدية</option>';
            const wilaya = dzData.find(w => w.code === wCode);
            if(wilaya) {
                wilaya.communes.forEach(c => comSel.innerHTML += `<option value="${c}">${c}</option>`);
                comSel.disabled = false;
            }
        };

        const renderProductPage = (p) => {
            document.getElementById('p-detail-content').innerHTML = `
                <img src="${p.image}" style="width:100%; border-radius:10px; margin-bottom:15px;">
                <h1>${p.name}</h1>
                <p style="color:#666; margin:10px 0;">${p.desc || ''}</p>
                <div style="font-size:1.5rem; color:var(--main-color); font-weight:800;">${p.price} دج</div>
            `;
            
            const container = document.getElementById('dynamic-selectors');
            container.innerHTML = "";
            document.getElementById('ord-size').value = "";
            document.getElementById('ord-color').value = "";
            document.getElementById('summary-area').style.display = "none";

            // Sizes
            let sizes = [];
            if(p.hasShoeSize) sizes = [36,37,38,39,40,41,42,43,44,45];
            else if(p.hasClothSize) sizes = p.clothType==='letters'?['S','M','L','XL','XXL']: [36,38,40,42,44];

            if(sizes.length > 0) {
                container.innerHTML += `<label style="font-weight:bold; display:block; margin-bottom:10px;">اختر المقاس:</label><div class="options-container" id="size-opts"></div>`;
                sizes.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'circle-option';
                    div.innerText = s;
                    div.onclick = function() {
                        document.querySelectorAll('#size-opts .circle-option').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('ord-size').value = s;
                        updateSummary();
                    };
                    document.getElementById('size-opts').appendChild(div);
                });
            } else {
                document.getElementById('ord-size').value = "عادي";
            }

            // Colors
            if(p.hasColors && p.colorsList) {
                const cols = p.colorsList.split(',').map(c => c.trim());
                container.innerHTML += `<label style="font-weight:bold; display:block; margin-bottom:10px;">اختر اللون:</label><div class="options-container" id="col-opts"></div>`;
                cols.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'circle-option';
                    div.innerText = c;
                    div.onclick = function() {
                        document.querySelectorAll('#col-opts .circle-option').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('ord-color').value = c;
                        updateSummary();
                    };
                    document.getElementById('col-opts').appendChild(div);
                });
            } else {
                document.getElementById('ord-color').value = "عادي";
            }
        };

        window.updateSummary = () => {
            const s = document.getElementById('ord-size').value;
            const c = document.getElementById('ord-color').value;
            if(s || c) {
                document.getElementById('summary-area').style.display = "block";
                document.getElementById('order-summary').innerText = `المقاس: ${s || 'لم يتم الاختيار'} | اللون: ${c || 'لم يتم الاختيار'}`;
            }
        };

        window.submitOrder = async (e) => {
            e.preventDefault();
            const s = document.getElementById('ord-size').value;
            const c = document.getElementById('ord-color').value;

            if((currentProd.hasShoeSize || currentProd.hasClothSize) && !s) return alert("يرجى اختيار المقاس أولاً");
            if(currentProd.hasColors && !c) return alert("يرجى اختيار اللون أولاً");

            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerText = "جاري إرسال طلبك...";

            const order = {
                pName: currentProd.name,
                price: currentProd.price,
                custName: document.getElementById('ord-name').value,
                custPhone: document.getElementById('ord-phone').value,
                wilaya: document.getElementById('ord-wilaya').options[document.getElementById('ord-wilaya').selectedIndex].text,
                commune: document.getElementById('ord-commune').value,
                size: s,
                color: c,
                date: new Date().toISOString()
            };

            await addDoc(collection(db, "orders"), order);
            alert("تم استلام طلبك بنجاح! سنتصل بك قريباً");
            nav('home');
            btn.disabled = false; btn.innerText = "إرسال الطلب الآن";
            e.target.reset();
        };

        // --- Initialize App ---
        async function init() {
            loadWilayas();
            
            onSnapshot(query(collection(db, "products"), orderBy("date", "desc")), (snap) => {
                products = [];
                const list = document.getElementById('products-list');
                const adminList = document.getElementById('admin-p-list');
                list.innerHTML = ""; adminList.innerHTML = "";
                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    products.push(p);
                    const urlName = p.name.replace(/\s+/g, '-');
                    list.innerHTML += `
                        <div class="product-card" onclick="nav('product', '${urlName}')">
                            <img src="${p.image}" class="p-img">
                            <div class="p-info">
                                <h3 style="font-size:1rem; margin-bottom:5px;">${p.name}</h3>
                                <span class="new-price">${p.price} دج</span>
                                ${p.oldPrice ? `<span class="old-price">${p.oldPrice}</span>` : ''}
                            </div>
                        </div>`;
                    adminList.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">${p.name} <button onclick="deleteP('${p.id}')">حذف</button></div>`;
                });
                
                // Check if current URL is a product
                const path = window.location.pathname;
                if(path.startsWith('/product/')) {
                    const pName = path.split('/product/')[1];
                    nav('product', pName);
                }
            });

            onSnapshot(doc(db, "settings", "main"), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    document.getElementById('store-title').innerText = d.name || "متجري";
                    document.getElementById('marquee-txt').innerText = d.marquee || "";
                    if(d.slider) {
                        const sCont = document.getElementById('main-slider');
                        sCont.innerHTML = "";
                        d.slider.split('\n').forEach((u, i) => {
                            if(u.trim()) sCont.innerHTML += `<div class="slide-item" style="position:absolute; width:100%; height:100%; background:url('${u.trim()}') center/cover; opacity:${i===0?1:0}; transition:1s;"></div>`;
                        });
                        let idx = 0;
                        setInterval(() => {
                            const slides = document.querySelectorAll('.slide-item');
                            if(slides.length > 1) {
                                slides[idx].style.opacity = 0;
                                idx = (idx + 1) % slides.length;
                                slides[idx].style.opacity = 1;
                            }
                        }, 4000);
                    }
                }
            });

            onSnapshot(query(collection(db, "orders"), orderBy("date", "desc")), (snap) => {
                const tb = document.getElementById('orders-tbody');
                tb.innerHTML = "";
                snap.forEach(d => {
                    const o = d.data();
                    tb.innerHTML += `<tr><td>${o.custName}<br>${o.custPhone}</td><td>${o.pName}<br><small>${o.size}/${o.color}</small></td><td>${o.price} دج</td></tr>`;
                });
            });
        }

        // Auth & Admin Actions
        window.login = () => {
            if(document.getElementById('adm-user').value === 'admin' && document.getElementById('adm-pass').value === 'abobob123') {
                localStorage.setItem('adminAuth', 'true'); nav('admin');
            } else alert('خطأ');
        };
        window.logout = () => { localStorage.removeItem('adminAuth'); nav('home'); };
        window.tab = (t) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            event.target.classList.add('active');
        };
        window.addProduct = async () => {
            const p = {
                name: document.getElementById('new-name').value,
                price: document.getElementById('new-price').value,
                oldPrice: document.getElementById('new-old-price').value,
                desc: document.getElementById('new-desc').value,
                image: document.getElementById('new-img-url').value,
                hasShoeSize: document.getElementById('has-shoe-size').checked,
                hasClothSize: document.getElementById('has-cloth-size').checked,
                clothType: document.getElementById('cloth-type-sel').value,
                hasColors: document.getElementById('has-colors').checked,
                colorsList: document.getElementById('color-list').value,
                date: new Date().toISOString()
            };
            await addDoc(collection(db, "products"), p);
            alert("تم");
        };
        window.deleteP = async(id) => { if(confirm('حذف؟')) await deleteDoc(doc(db, "products", id)); };
        window.saveSettings = async () => {
            await setDoc(doc(db, "settings", "main"), {
                name: document.getElementById('set-name').value,
                marquee: document.getElementById('set-marq').value,
                slider: document.getElementById('set-slider').value
            });
            alert("تم الحفظ");
        };

        init();
    </script>
</body>
</html>
