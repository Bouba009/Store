<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجري الإلكتروني</title>
    <!-- خط تجوال -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- أيقونات FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --main-color: #ff6600; /* اللون الافتراضي */
            --text-color: #333;
            --bg-color: #f4f6f8;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* Themes */
        body.theme-orange { --main-color: #ff6600; }
        body.theme-green { --main-color: #27ae60; }
        body.theme-blue { --main-color: #2980b9; }
        body.theme-purple { --main-color: #8e44ad; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); overflow-x: hidden; padding-bottom: 60px;}
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        button { cursor: pointer; font-family: 'Tajawal', sans-serif;}
        input, select, textarea { font-family: 'Tajawal', sans-serif;}

        /* --- Header --- */
        header {
            background: var(--white);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-area img { height: 40px; }
        .logo-area h2 { font-size: 1.2rem; font-weight: 800; color: var(--main-color); }
        .nav-icons { display: flex; gap: 15px; font-size: 1.2rem; color: #555; }
        .nav-icons i { cursor: pointer; transition: 0.3s; }
        .nav-icons i:hover { color: var(--main-color); }

        /* --- Sidebar --- */
        .sidebar {
            position: fixed; top: 0; right: -280px; width: 280px; height: 100%;
            background: var(--white); z-index: 1001; padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: 0.3s ease;
        }
        .sidebar.active { right: 0; }
        .close-sidebar { font-size: 1.5rem; cursor: pointer; margin-bottom: 20px; }
        .sidebar-links a { display: block; padding: 12px 0; border-bottom: 1px solid #eee; font-weight: bold; }

        /* --- Pages Container --- */
        .page-section { display: none; animation: fadeIn 0.5s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Slider --- */
        .slider { width: 100%; height: 250px; position: relative; overflow: hidden; margin-bottom: 10px; }
        .slide {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background-size: cover; background-position: center; opacity: 0; transition: opacity 1s;
        }
        .slide.active { opacity: 1; }

        /* --- Marquee --- */
        .marquee-container {
            background: var(--main-color); color: white; padding: 8px 0; overflow: hidden; white-space: nowrap;
        }
        .marquee-text {
            display: inline-block; animation: marquee 15s linear infinite; font-weight: bold;
        }
        @keyframes marquee {
            0% { transform: translateX(-100vw); }
            100% { transform: translateX(100vw); }
        }

        /* --- Products Grid --- */
        .products-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); } }

        .product-card {
            background: var(--white); border-radius: 10px; overflow: hidden;
            box-shadow: var(--shadow); position: relative; transition: transform 0.3s;
        }
        .product-card:hover { transform: translateY(-5px); }
        .p-img { width: 100%; height: 180px; object-fit: cover; }
        .p-details { padding: 10px; }
        .p-title { font-size: 0.9rem; margin-bottom: 5px; height: 35px; overflow: hidden; }
        .p-prices { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .new-price { color: var(--main-color); font-weight: bold; font-size: 1.1rem; }
        .old-price { text-decoration: line-through; color: #999; font-size: 0.8rem; }
        .discount-badge {
            position: absolute; top: 10px; right: 10px; background: #e74c3c;
            color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px;
        }
        .rating { color: #f1c40f; font-size: 0.8rem; }

        /* --- Product Details Page --- */
        .product-view-container { padding: 20px; max-width: 800px; margin: auto; background: var(--white); margin-top: 20px; border-radius: 10px; }
        .pv-img { width: 100%; max-height: 400px; object-fit: contain; border-radius: 10px; }
        .order-form { margin-top: 20px; background: #fafafa; padding: 20px; border-radius: 10px; border: 1px solid #eee; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .btn-buy { width: 100%; background: var(--main-color); color: white; padding: 15px; border: none; border-radius: 5px; font-weight: bold; font-size: 1.1rem; }
        
        /* --- Footer Animation --- */
        .footer-anim { background: #e0e0e0; padding: 15px; overflow: hidden; text-align: center; position: relative; }
        .truck-icon { font-size: 2rem; color: #555; animation: drive 4s linear infinite; position: absolute; bottom: 5px; }
        @keyframes drive {
            0% { left: -50px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 100%; opacity: 0; }
        }
        .main-footer { background: #222; color: #ccc; padding: 30px 20px; text-align: center; margin-top: 30px; }
        .footer-links a { color: var(--white); margin: 0 10px; }

        /* --- Admin Panel --- */
        .login-box { max-width: 350px; margin: 100px auto; padding: 30px; background: white; border-radius: 10px; text-align: center; box-shadow: var(--shadow); }
        .admin-dashboard { padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: var(--shadow); }
        .stat-num { font-size: 2rem; font-weight: bold; color: var(--main-color); }
        
        .admin-tabs button { padding: 10px 20px; border: none; background: #ddd; margin-left: 5px; }
        .admin-tabs button.active { background: var(--main-color); color: white; }
        .admin-section { display: none; background: white; padding: 20px; margin-top: 15px; border-radius: 8px; }
        .admin-section.active { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        th { background: #f9f9f9; }
        .status-new { color: green; font-weight: bold; }
        
        .floating-btn {
            position: fixed; bottom: 20px; left: 20px; background: #25D366; color: white;
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 999;
        }
    </style>
</head>
<body class="theme-orange">

    <!-- Header -->
    <header>
        <div class="logo-area">
            <div id="logo-container"></div>
            <h2 id="store-name-display">المتجر الإلكتروني</h2>
        </div>
        <div class="nav-icons">
            <i class="fas fa-search"></i>
            <i class="fas fa-shopping-cart"></i>
            <i class="fas fa-user" onclick="navigateTo('login')"></i>
            <i class="fas fa-bars" onclick="toggleSidebar()"></i>
        </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div style="display: flex; justify-content: space-between;">
            <h3>القائمة</h3>
            <span class="close-sidebar" onclick="toggleSidebar()">✕</span>
        </div>
        <div class="sidebar-links" id="category-list">
            <a href="#" onclick="navigateTo('home')">الرئيسية</a>
            <!-- Categories injected here -->
        </div>
        <hr style="margin: 15px 0;">
        <div class="sidebar-links">
            <a href="#">من نحن</a>
            <a href="#">سياسة الخصوصية</a>
            <a href="#">اتصل بنا</a>
        </div>
    </div>

    <!-- VIEW: HOME -->
    <div id="home-view" class="page-section active">
        <!-- Slider -->
        <div class="slider" id="slider-container">
            <!-- Slides injected via JS -->
        </div>

        <!-- Marquee -->
        <div class="marquee-container">
            <div class="marquee-text" id="marquee-text-display">
                استفد من عرض اليوم (عرض محدود) - شحن مجاني للطلبات الكبيرة
            </div>
        </div>

        <!-- Products -->
        <div class="products-container">
            <h2 style="text-align: center; margin-bottom: 20px;">أحدث المنتجات</h2>
            <div class="grid" id="products-grid">
                <!-- Products injected via JS -->
                <p style="text-align:center; width:100%;">جاري التحميل...</p>
            </div>
        </div>
    </div>

    <!-- VIEW: PRODUCT DETAILS -->
    <div id="product-view" class="page-section">
        <div class="product-view-container">
            <button onclick="navigateTo('home')" style="margin-bottom:10px; border:none; background:none; color:#555;"><i class="fas fa-arrow-right"></i> عودة</button>
            <div id="product-detail-content"></div>
            
            <form id="order-form" class="order-form" onsubmit="submitOrder(event)">
                <h3 style="margin-bottom: 15px; color: var(--main-color);">اطلب الآن (الدفع عند الاستلام)</h3>
                <input type="hidden" id="order-pid">
                <input type="hidden" id="order-pname">
                <input type="hidden" id="order-price">
                
                <div class="form-group">
                    <label>الاسم الكامل</label>
                    <input type="text" id="cust-name" required>
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="tel" id="cust-phone" required>
                </div>
                <div class="form-group">
                    <label>العنوان / الولاية</label>
                    <input type="text" id="cust-address" required>
                </div>
                
                <!-- Dynamic Options -->
                <div id="dynamic-options"></div>

                <button type="submit" class="btn-buy">تأكيد الطلب</button>
            </form>
        </div>
    </div>

    <!-- VIEW: LOGIN -->
    <div id="login-view" class="page-section">
        <div class="login-box">
            <h2>دخول الأدمن</h2>
            <input type="text" id="admin-user" placeholder="اسم المستخدم" style="width:100%; padding:10px; margin:10px 0;">
            <input type="password" id="admin-pass" placeholder="كلمة المرور" style="width:100%; padding:10px; margin:10px 0;">
            <button onclick="adminLogin()" style="width:100%; padding:10px; background:var(--main-color); color:white; border:none;">دخول</button>
        </div>
    </div>

    <!-- VIEW: ADMIN DASHBOARD -->
    <div id="admin-view" class="page-section">
        <div class="admin-dashboard">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>لوحة التحكم</h2>
                <button onclick="adminLogout()" style="background:red; color:white; padding:5px 10px; border:none;">خروج</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>جميع الطلبات</h3>
                    <div class="stat-num" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <h3>طلبات جديدة</h3>
                    <div class="stat-num" id="stat-new">0</div>
                </div>
                <div class="stat-card">
                    <h3>المنتجات</h3>
                    <div class="stat-num" id="stat-products">0</div>
                </div>
                <div class="stat-card">
                    <h3>زيارات اليوم</h3>
                    <div class="stat-num">125</div>
                </div>
            </div>

            <div class="admin-tabs">
                <button onclick="switchAdminTab('orders')" class="active">الطلبات</button>
                <button onclick="switchAdminTab('products')">المنتجات</button>
                <button onclick="switchAdminTab('settings')">الإعدادات</button>
            </div>

            <!-- Admin: Orders -->
            <div id="tab-orders" class="admin-section active">
                <table id="orders-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الزبون</th>
                            <th>المنتج</th>
                            <th>السعر</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Admin: Products -->
            <div id="tab-products" class="admin-section">
                <h3>إضافة منتج جديد</h3>
                <div class="form-group"><input type="text" id="new-p-name" placeholder="اسم المنتج"></div>
                <div class="form-group" style="display:flex; gap:10px;">
                    <input type="number" id="new-p-price" placeholder="السعر">
                    <input type="number" id="new-p-old" placeholder="السعر القديم">
                </div>
                <div class="form-group"><input type="text" id="new-p-img" placeholder="رابط الصورة"></div>
                <div class="form-group"><textarea id="new-p-desc" placeholder="الوصف"></textarea></div>
                <div class="form-group"><input type="text" id="new-p-sizes" placeholder="المقاسات (بفاصلة)"></div>
                <div class="form-group"><input type="text" id="new-p-colors" placeholder="الألوان (بفاصلة)"></div>
                <button onclick="addProduct()" style="background:green; color:white; padding:10px; width:100%;">إضافة</button>
                
                <h3 style="margin-top:20px;">قائمة المنتجات</h3>
                <div id="admin-products-list"></div>
            </div>

            <!-- Admin: Settings -->
            <div id="tab-settings" class="admin-section">
                <div class="form-group">
                    <label>اسم المتجر</label>
                    <input type="text" id="set-store-name">
                </div>
                <div class="form-group">
                    <label>نص الشريط المتحرك</label>
                    <input type="text" id="set-marquee">
                </div>
                <div class="form-group">
                    <label>صور السلايدر (روابط مفصولة بفاصلة)</label>
                    <textarea id="set-slider"></textarea>
                </div>
                <div class="form-group">
                    <label>الثيم</label>
                    <select id="set-theme">
                        <option value="theme-orange">برتقالي</option>
                        <option value="theme-green">أخضر</option>
                        <option value="theme-blue">أزرق</option>
                        <option value="theme-purple">بنفسجي</option>
                    </select>
                </div>
                <button onclick="saveSettings()" style="background:var(--main-color); color:white; padding:10px; width:100%;">حفظ الإعدادات</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-anim">
        <p>شحن سريع لجميع الولايات (58 ولاية) - سياسة استبدال مرنة</p>
        <i class="fas fa-truck truck-icon"></i>
    </div>
    <div class="main-footer">
        <div class="footer-links">
            <a href="#">سياسة الخصوصية</a> | 
            <a href="#">اتصل بنا</a> | 
            <a href="#">من نحن</a>
        </div>
        <p style="margin-top:10px; font-size:0.8rem;">جميع الحقوق محفوظة &copy; 2024</p>
    </div>

    <a href="https://wa.me/123456789" class="floating-btn"><i class="fab fa-whatsapp"></i></a>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o",
            authDomain: "mourafik-e9161.firebaseapp.com",
            projectId: "mourafik-e9161",
            storageBucket: "mourafik-e9161.firebasestorage.app",
            messagingSenderId: "133465287328",
            appId: "1:133465287328:web:9de5b3bd709099d885b7c5",
            measurementId: "G-MDJXPZ7G5L"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let productsCache = [];
        let currentSettings = {};

        // --- NAVIGATION ---
        window.navigateTo = function(viewId, param = null) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById('sidebar').classList.remove('active');
            
            // Hash routing logic
            if(viewId === 'product') {
                document.getElementById('product-view').classList.add('active');
                loadProductDetails(param); // param is product ID
                window.location.hash = `product/${param}`;
            } else if (viewId === 'admin') {
                 if(localStorage.getItem('adminLoggedIn') === 'true') {
                     document.getElementById('admin-view').classList.add('active');
                     loadAdminData();
                 } else {
                     document.getElementById('login-view').classList.add('active');
                 }
            } else {
                document.getElementById(viewId + '-view').classList.add('active');
                window.location.hash = viewId;
            }
            window.scrollTo(0,0);
        };

        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('active');
        };

        // --- LOAD DATA (HOME) ---
        async function initApp() {
            // Listen to settings
            onSnapshot(doc(db, "settings", "config"), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    currentSettings = data;
                    applySettings(data);
                }
            });

            // Listen to products
            const q = query(collection(db, "products"), orderBy("date", "desc"));
            onSnapshot(q, (snapshot) => {
                productsCache = [];
                const grid = document.getElementById('products-grid');
                grid.innerHTML = "";
                
                snapshot.forEach(doc => {
                    const p = {id: doc.id, ...doc.data()};
                    productsCache.push(p);
                    const discount = p.oldPrice ? Math.round(((p.oldPrice - p.price)/p.oldPrice)*100) : 0;
                    
                    grid.innerHTML += `
                        <div class="product-card" onclick="navigateTo('product', '${p.id}')">
                            <img src="${p.image}" class="p-img" loading="lazy">
                            ${discount > 0 ? `<span class="discount-badge">-${discount}%</span>` : ''}
                            <div class="p-details">
                                <h3 class="p-title">${p.name}</h3>
                                <div class="p-prices">
                                    <span class="new-price">${p.price} DZD</span>
                                    ${p.oldPrice ? `<span class="old-price">${p.oldPrice}</span>` : ''}
                                </div>
                                <div class="rating">⭐⭐⭐⭐⭐</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function applySettings(data) {
            if(data.storeName) document.getElementById('store-name-display').innerText = data.storeName;
            if(data.marqueeText) document.getElementById('marquee-text-display').innerText = data.marqueeText;
            if(data.theme) document.body.className = data.theme;
            
            // Slider
            const sliderContainer = document.getElementById('slider-container');
            if(data.sliderImages && data.sliderImages.length > 0) {
                sliderContainer.innerHTML = '';
                data.sliderImages.forEach((img, idx) => {
                    sliderContainer.innerHTML += `<div class="slide ${idx===0?'active':''}" style="background-image: url('${img}')"></div>`;
                });
                // Restart animation logic
            }
        }

        // --- SLIDER ANIMATION ---
        setInterval(() => {
            const slides = document.querySelectorAll('.slide');
            if(slides.length === 0) return;
            let activeIdx = 0;
            slides.forEach((s, i) => { if(s.classList.contains('active')) activeIdx = i; });
            slides[activeIdx].classList.remove('active');
            slides[(activeIdx + 1) % slides.length].classList.add('active');
        }, 2000);

        // --- PRODUCT DETAILS ---
        async function loadProductDetails(pid) {
            const product = productsCache.find(p => p.id === pid);
            if(!product) return; // Or fetch from DB if not in cache

            const content = document.getElementById('product-detail-content');
            const discount = product.oldPrice ? Math.round(((product.oldPrice - product.price)/product.oldPrice)*100) : 0;

            content.innerHTML = `
                <img src="${product.image}" class="pv-img">
                <h1 style="margin:10px 0;">${product.name}</h1>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <span style="font-size:1.5rem; color:var(--main-color); font-weight:bold;">${product.price} DZD</span>
                    ${product.oldPrice ? `<span style="text-decoration:line-through; color:#999;">${product.oldPrice}</span>` : ''}
                    ${discount > 0 ? `<span style="background:red; color:white; padding:2px 5px; border-radius:4px;">تخفيض ${discount}%</span>` : ''}
                </div>
                <p style="line-height:1.6; color:#555;">${product.description || 'لا يوجد وصف'}</p>
                <div style="color:gold; margin:10px 0;">⭐⭐⭐⭐⭐ (تقييم العملاء)</div>
            `;

            // Setup Form Data
            document.getElementById('order-pid').value = pid;
            document.getElementById('order-pname').value = product.name;
            document.getElementById('order-price').value = product.price;

            // Options
            let optsHtml = '';
            if(product.sizes) {
                optsHtml += `<div class="form-group"><label>المقاس</label><select id="opt-size">`;
                product.sizes.split(',').forEach(s => optsHtml += `<option value="${s.trim()}">${s.trim()}</option>`);
                optsHtml += `</select></div>`;
            }
            if(product.colors) {
                optsHtml += `<div class="form-group"><label>اللون</label><select id="opt-color">`;
                product.colors.split(',').forEach(c => optsHtml += `<option value="${c.trim()}">${c.trim()}</option>`);
                optsHtml += `</select></div>`;
            }
            document.getElementById('dynamic-options').innerHTML = optsHtml;
        }

        // --- ORDER SUBMISSION ---
        window.submitOrder = async function(e) {
            e.preventDefault();
            const btn = document.querySelector('.btn-buy');
            btn.innerText = "جاري الإرسال...";
            btn.disabled = true;

            const order = {
                productId: document.getElementById('order-pid').value,
                productName: document.getElementById('order-pname').value,
                price: Number(document.getElementById('order-price').value),
                customerName: document.getElementById('cust-name').value,
                customerPhone: document.getElementById('cust-phone').value,
                customerAddress: document.getElementById('cust-address').value,
                size: document.getElementById('opt-size') ? document.getElementById('opt-size').value : '-',
                color: document.getElementById('opt-color') ? document.getElementById('opt-color').value : '-',
                date: new Date().toISOString(),
                status: 'new'
            };

            try {
                await addDoc(collection(db, "orders"), order);
                alert("تم استلام طلبك بنجاح! سنتصل بك قريباً.");
                navigateTo('home');
            } catch (err) {
                console.error(err);
                alert("حدث خطأ!");
            }
            btn.innerText = "تأكيد الطلب";
            btn.disabled = false;
        };

        // --- ADMIN AUTH ---
        window.adminLogin = function() {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            if(u === 'admin' && p === 'abobob123') {
                localStorage.setItem('adminLoggedIn', 'true');
                navigateTo('admin');
            } else {
                alert("بيانات خاطئة");
            }
        };

        window.adminLogout = function() {
            localStorage.removeItem('adminLoggedIn');
            navigateTo('home');
        };

        // --- ADMIN FUNCTIONS ---
        window.switchAdminTab = function(tab) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            // Update buttons style
            document.querySelectorAll('.admin-tabs button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        };

        function loadAdminData() {
            // Orders Listener
            const q = query(collection(db, "orders"), orderBy("date", "desc"));
            onSnapshot(q, (snap) => {
                const tbody = document.querySelector('#orders-table tbody');
                tbody.innerHTML = '';
                let total = 0, newOrders = 0;
                
                snap.forEach(doc => {
                    const d = doc.data();
                    total++;
                    if(d.status === 'new') newOrders++;
                    
                    const date = new Date(d.date).toLocaleDateString('ar-EG');
                    tbody.innerHTML += `
                        <tr style="${d.status==='new'?'background:#e8f5e9':''}">
                            <td>${date}</td>
                            <td>${d.customerName}<br>${d.customerPhone}<br>${d.customerAddress}</td>
                            <td>${d.productName}<br><small>${d.size} | ${d.color}</small></td>
                            <td>${d.price}</td>
                            <td class="${d.status==='new'?'status-new':''}">${d.status}</td>
                        </tr>
                    `;
                });
                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-new').innerText = newOrders;
            });

            // Products List for Admin
            const pList = document.getElementById('admin-products-list');
            pList.innerHTML = '';
            productsCache.forEach(p => {
                pList.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${p.image}" width="40">
                            <b>${p.name}</b>
                        </div>
                        <button onclick="deleteProduct('${p.id}')" style="background:red; color:white; border:none; padding:5px;">حذف</button>
                    </div>
                `;
            });
            document.getElementById('stat-products').innerText = productsCache.length;

            // Load Settings Values into Inputs
            if(currentSettings) {
                document.getElementById('set-store-name').value = currentSettings.storeName || '';
                document.getElementById('set-marquee').value = currentSettings.marqueeText || '';
                document.getElementById('set-slider').value = currentSettings.sliderImages ? currentSettings.sliderImages.join(',') : '';
                document.getElementById('set-theme').value = currentSettings.theme || 'theme-orange';
            }
        }

        window.addProduct = async function() {
            const p = {
                name: document.getElementById('new-p-name').value,
                price: Number(document.getElementById('new-p-price').value),
                oldPrice: Number(document.getElementById('new-p-old').value),
                image: document.getElementById('new-p-img').value,
                description: document.getElementById('new-p-desc').value,
                sizes: document.getElementById('new-p-sizes').value,
                colors: document.getElementById('new-p-colors').value,
                date: new Date().toISOString()
            };
            if(!p.name || !p.price) return alert("الاسم والسعر مطلوبان");
            
            await addDoc(collection(db, "products"), p);
            alert("تمت الإضافة");
            document.getElementById('new-p-name').value = ''; 
            // clear others...
        };

        window.deleteProduct = async function(id) {
            if(confirm("هل أنت متأكد من الحذف؟")) {
                await deleteDoc(doc(db, "products", id));
            }
        };

        window.saveSettings = async function() {
            const sliders = document.getElementById('set-slider').value.split(',').filter(x => x.trim() !== '');
            const data = {
                storeName: document.getElementById('set-store-name').value,
                marqueeText: document.getElementById('set-marquee').value,
                theme: document.getElementById('set-theme').value,
                sliderImages: sliders
            };
            await setDoc(doc(db, "settings", "config"), data);
            alert("تم حفظ الإعدادات!");
        };

        // Initialize
        initApp();
        
        // Handle URL Hash on load
        window.onload = () => {
            const hash = window.location.hash;
            if(hash.includes('product/')) {
                navigateTo('product', hash.split('/')[1]);
            } else if (hash === '#admin') {
                navigateTo('admin');
            } else {
                navigateTo('home');
            }
        };
    </script>
</body>
</html>
